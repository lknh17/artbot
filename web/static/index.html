<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>artbot æ§åˆ¶å°</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
header { text-align: center; padding: 40px 0 30px; }
header h1 { font-size: 28px; background: linear-gradient(135deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
header p { color: #94a3b8; margin-top: 8px; font-size: 14px; }
.tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid #1e293b; padding-bottom: 12px; flex-wrap: wrap; }
.tab { padding: 8px 20px; border-radius: 8px 8px 0 0; cursor: pointer; color: #94a3b8; font-size: 14px; transition: all 0.2s; }
.tab.active { background: #1e293b; color: #60a5fa; }
.tab:hover { color: #e2e8f0; }
.panel { display: none; }
.panel.active { display: block; }
.card { background: #1e293b; border-radius: 16px; padding: 24px; margin-bottom: 20px; border: 1px solid #334155; }
.card h3 { font-size: 16px; color: #60a5fa; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
.card h3::before { content: ''; width: 4px; height: 16px; background: #60a5fa; border-radius: 2px; }
.form-group { margin-bottom: 16px; }
.form-group label { display: block; font-size: 13px; color: #94a3b8; margin-bottom: 6px; }
.form-group .hint { font-size: 11px; color: #64748b; margin-top: 4px; }
.form-group input, .form-group textarea, .form-group select {
    width: 100%; padding: 10px 14px; background: #0f172a; border: 1px solid #334155;
    border-radius: 8px; color: #e2e8f0; font-size: 14px; outline: none; transition: border 0.2s;
}
.form-group input:focus, .form-group textarea:focus { border-color: #60a5fa; }
.form-group textarea { resize: vertical; min-height: 80px; }
.btn { padding: 10px 24px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
.btn-primary { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(59,130,246,0.4); }
.btn-secondary { background: #334155; color: #e2e8f0; }
.btn-secondary:hover { background: #475569; }
.btn-sm { padding: 6px 14px; font-size: 12px; }
.btn-danger { background: #991b1b; color: #fca5a5; }
.themes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
.theme-card { padding: 12px 8px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; text-align: center; }
.theme-card.selected { border-color: #60a5fa; box-shadow: 0 0 20px rgba(96,165,250,0.2); }
.theme-card:hover { transform: translateY(-2px); }
.theme-name { font-size: 11px; font-weight: 600; margin-top: 6px; }
.theme-dot { width: 28px; height: 28px; border-radius: 50%; margin: 0 auto; }
.theme-layout-tag { font-size: 9px; color: #94a3b8; margin-top: 2px; }
.hot-list { list-style: none; }
.hot-item { padding: 10px 0; border-bottom: 1px solid #1e293b; display: flex; justify-content: space-between; align-items: center; }
.hot-item:last-child { border-bottom: none; }
.hot-title { font-size: 14px; flex: 1; cursor: pointer; }
.hot-title:hover { color: #60a5fa; }
.draft-item { padding: 12px 16px; background: #0f172a; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.status-bar { padding: 12px 16px; border-radius: 8px; font-size: 13px; margin-bottom: 16px; }
.status-idle { background: #1e293b; color: #94a3b8; }
.status-pending { background: #1e3a5f; color: #60a5fa; }
.status-done { background: #1a3a2a; color: #4ade80; }
.row { display: flex; gap: 20px; }
.col-8 { flex: 2; }
.col-4 { flex: 1; }
@media (max-width: 768px) { .row { flex-direction: column; } .themes-grid { grid-template-columns: repeat(2, 1fr); } }
.toast { position: fixed; top: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; background: #1e3a5f; color: #60a5fa; font-size: 14px; z-index: 100; display: none; }
.preview-frame { border: 1px solid #334155; border-radius: 12px; overflow: hidden; background: #fff; min-height: 400px; }
.preview-frame iframe { width: 100%; min-height: 500px; border: none; }
.chip { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; margin: 2px 4px; cursor: pointer; }
.chip-on { background: #1e3a5f; color: #60a5fa; }
.chip-off { background: #1e293b; color: #64748b; }
.chip-off:hover { color: #94a3b8; }
.stat-card { text-align: center; padding: 20px; }
.stat-num { font-size: 28px; font-weight: 700; color: #60a5fa; }
.stat-label { font-size: 12px; color: #94a3b8; margin-top: 4px; }
.checkbox-row { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
.checkbox-row input[type=checkbox] { width: auto; }
.checkbox-row label { color: #94a3b8; font-size: 13px; margin: 0; }
</style>
</head>
<body>

<div class="container">
    <header>
        <h1>artbot æ§åˆ¶å°</h1>
        <p>å¤šå¹³å° Â· å¤šè´¦å· Â· ç”Ÿæˆ/æ’ç‰ˆ/å‘å¸ƒ/ç»Ÿè®¡ ä¸€ä½“åŒ–</p>
        <p style="margin-top:6px; font-size:12px; color:#64748b;">UI build: 2026-02-25 15:20</p>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('jobs')">ğŸ§© Jobs</div>
        <div class="tab" onclick="switchTab('accounts')">ğŸ‘¤ Accounts</div>
        <div class="tab" onclick="switchTab('profiles')">ğŸ­ Profiles</div>
        <div class="tab" onclick="switchTab('layouts')">ğŸ¨ Layouts</div>
        <div class="tab" onclick="switchTab('autotopic')">ğŸ¯ è‡ªåŠ¨é€‰é¢˜</div>
        <div class="tab" onclick="switchTab('topicbanks')">ğŸ“š é€‰é¢˜åº“</div>
        <div class="tab" onclick="switchTab('bench')">ğŸ“ˆ çˆ†æ¬¾åº“</div>
        <div class="tab" onclick="switchTab('topics2')">ğŸ“š é€‰é¢˜åº“ï¼ˆæ–°æµç¨‹ï¼‰</div>
        <div class="tab" onclick="switchTab('write')">âœï¸ å†…å®¹æ’°å†™</div>
        <div class="tab" onclick="switchTab('inventory')">ğŸ“¦ åº“å­˜ï¼ˆè‰ç¨¿/å·²å‘å¸ƒï¼‰</div>
        <div class="tab" onclick="switchTab('hot')">ğŸ”¥ Trend</div>
        <div class="tab" onclick="switchTab('stats')">ğŸ“Š Stats</div>
        <div class="tab" onclick="switchTab('settings')">âš™ï¸ Settings</div>
    </div>

    <!-- ==================== Jobs ==================== -->
    <div id="panel-jobs" class="panel active">
        <div id="status-bar" class="status-bar status-idle">ç³»ç»Ÿå°±ç»ª</div>
        <div class="row">
            <div class="col-8">
                <div class="card">
                    <h3>æ‰‹åŠ¨æ–‡ç« ç”Ÿæˆ</h3>
                    <div class="form-group">
                        <label>é€‰æ‹©è´¦å·</label>
                        <select id="job_account" onchange="onJobAccountChange()"></select>
                    </div>
                    <div class="form-group">
                        <label>å…³é”®è¯ / ä¸»é¢˜ / çƒ­ç‚¹æè¿°</label>
                        <textarea id="keyword" placeholder="è¶Šå…·ä½“è¶Šå¥½ï¼šäº‹ä»¶+è§‚ç‚¹+å—ä¼—+è¯­æ°”"></textarea>
                    </div>
                    <div class="form-group">
                        <label>æ’å›¾æ•°é‡</label>
                        <select id="num_images">
                            <option value="0">æ— æ’å›¾</option>
                            <option value="1">1 å¼ </option>
                            <option value="2" selected>2 å¼ </option>
                            <option value="3">3 å¼ </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é¢å¤–è¦æ±‚ï¼ˆå¯é€‰ï¼‰</label>
                        <textarea id="extra_prompt" rows="3" placeholder="ä¾‹å¦‚ï¼šå¹½é»˜ã€1000å­—ã€å¼ºè§‚ç‚¹ã€ç»“å°¾ç»™æ¸…å•"></textarea>
                    </div>
                    <div class="checkbox-row">
                        <input type="checkbox" id="push_to_draft">
                        <label for="push_to_draft">ç”Ÿæˆå®Œæˆåè‡ªåŠ¨æ¨é€åˆ°å…¬ä¼—å·è‰ç¨¿ç®±</label>
                    </div>
                    <button class="btn btn-primary" onclick="generateArticle()">ğŸš€ å¼€å§‹ç”Ÿæˆ</button>
                </div>
            </div>
            <div class="col-4">
                <div class="card">
                    <h3>æ’ç‰ˆä¸»é¢˜</h3>
                    <div id="themes-grid" class="themes-grid"></div>
                </div>
            </div>
        </div>
        <div class="card">
            <h3>æœ€è¿‘ç”Ÿæˆçš„æ–‡ç« </h3>
            <div style="color:#64748b; font-size:12px; margin:-6px 0 10px 0;">å±•ç¤ºæ ‡é¢˜ / æ›´æ–°æ—¶é—´ / æ–‡ä»¶å¤§å°ã€‚é¢„è§ˆæ—æä¾› Debug æŸ¥çœ‹æœ€ç»ˆ prompts ä¸æ¨¡æ¿ä¿¡æ¯ã€‚</div>
            <div id="draft-list"></div>
        </div>

        <!-- Draft Debug Modal -->
        <div id="draft-debug-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:200; padding:24px;">
            <div style="max-width:980px; margin:0 auto; background:#0b1220; border:1px solid #334155; border-radius:14px; overflow:hidden;">
                <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px; background:#111c33; border-bottom:1px solid #334155;">
                    <div style="font-weight:700; color:#e2e8f0;">ğŸ§ª Draft Debug</div>
                    <button class="btn btn-secondary btn-sm" onclick="closeDraftDebug()">å…³é—­</button>
                </div>
                <div id="draft-debug-body" style="padding:16px; max-height:70vh; overflow:auto;"></div>
            </div>
        </div>
    </div>

    <!-- ==================== Accounts ==================== -->
    <div id="panel-accounts" class="panel">
        <div class="card">
            <h3>è´¦å·ç®¡ç†</h3>
            <p style="color:#94a3b8; font-size:13px; margin-bottom:16px;">æ¯ä¸ªè´¦å·å¯¹åº”ä¸€ä¸ªå¹³å°çš„å‘å¸ƒæ¸ é“ã€‚å…¬ä¼—å·çš„ AppID / Secret åœ¨æ­¤é…ç½®ã€‚</p>
            <div style="display:flex; gap:10px; margin-bottom:16px;">
                <button class="btn btn-primary btn-sm" onclick="addAccount()">+ æ–°å¢è´¦å·</button>
                <button class="btn btn-secondary btn-sm" onclick="loadAccounts()">åˆ·æ–°</button>
                <button class="btn btn-primary btn-sm" onclick="saveAccounts()">ğŸ’¾ ä¿å­˜</button>
            </div>
            <div id="accounts-list"></div>
        </div>
    </div>

    <!-- ==================== Profiles ==================== -->
    <div id="panel-profiles" class="panel">
        <div class="card">
            <h3>è´¦å·ä¸ªæ€§åŒ– (Profiles)</h3>
            <p style="color:#94a3b8; font-size:13px; margin-bottom:12px;">ä¸ºæ¯ä¸ªè´¦å·é…ç½®å†™ä½œé£æ ¼ã€æ’ç‰ˆä¸»é¢˜ã€å›¾ç‰‡ç”Ÿæˆè¦æ±‚ç­‰ã€‚æ‰€æœ‰å­—æ®µéƒ½ä¼šå½±å“æœ€ç»ˆç”Ÿæˆæ•ˆæœã€‚</p>
            <div class="form-group">
                <label>é€‰æ‹©è´¦å·</label>
                <select id="profile_account" onchange="renderProfileEditor()"></select>
            </div>
            <div id="profile-editor" style="margin-top:12px;"></div>
            <div style="margin-top:16px;">
                <button class="btn btn-primary" onclick="saveProfile()">ğŸ’¾ ä¿å­˜ Profile</button>
            </div>
        </div>
        <!-- Debug prompt preview -->
        <details id="profile-debug" class="card" style="cursor:pointer;" ontoggle="renderProfileEditor()">
            <summary style="color:#f59e0b; font-weight:600; font-size:14px;">ğŸ”§ Debug: æŸ¥çœ‹æœ€ç»ˆ Prompt é¢„è§ˆ</summary>
            <p style="color:#64748b; font-size:12px; margin:8px 0;">ä»¥ä¸‹å±•ç¤ºåŸºäºå½“å‰ Profile é…ç½®ç”Ÿæˆçš„ 3 ä¸ª promptã€‚<code style="color:#f59e0b;">{å ä½ç¬¦}</code> è¡¨ç¤ºè¿è¡Œæ—¶ç”±æ¥å£åŠ¨æ€ä¼ å…¥çš„ä¿¡æ¯ã€‚</p>
            <div id="debug-prompts" style="margin-top:12px;"></div>
        </details>
    </div>

    <!-- ==================== Layouts ==================== -->
    <div id="panel-layouts" class="panel">
        <div class="row">
            <div class="col-4">
                <div class="card">
                    <h3>é€‰æ‹©ä¸»é¢˜</h3>
                    <div class="form-group">
                        <label>é¢„è§ˆå¹³å°</label>
                        <select id="layout-platform" onchange="loadLayoutThemes()">
                            <option value="wechat">å…¬ä¼—å·</option>
                            <option value="xhs">å°çº¢ä¹¦</option>
                        </select>
                    </div>
                    <div id="layout-themes" class="themes-grid"></div>
                </div>
            </div>
            <div class="col-8">
                <div class="card">
                    <h3>é¢„è§ˆæ•ˆæœ</h3>
                    <div id="layout-preview" class="preview-frame">
                        <div style="padding:40px; text-align:center; color:#94a3b8;">â† é€‰æ‹©ä¸€ä¸ªä¸»é¢˜æŸ¥çœ‹é¢„è§ˆ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== è‡ªåŠ¨é€‰é¢˜ ==================== -->
    <div id="panel-autotopic" class="panel">
        <div class="card">
            <h3>è‡ªåŠ¨é€‰é¢˜é…ç½®</h3>
            <p style="color:#94a3b8; font-size:13px; margin-bottom:16px;">é…ç½®å®šæ—¶è‡ªåŠ¨é€‰é¢˜ â†’ ç”Ÿæˆæ–‡ç« çš„æµç¨‹ã€‚åŸºäºçƒ­ç‚¹æ•°æ® + æœç´¢å¼•æ“è¡¥å……ç´ æã€‚</p>

            <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; margin-bottom:12px;">
                <div class="form-group" style="margin:0; min-width:220px;">
                    <label>å¯ç”¨è‡ªåŠ¨é€‰é¢˜</label>
                    <select id="at_enabled">
                        <option value="false">å…³é—­</option>
                        <option value="true">å¼€å¯</option>
                    </select>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="runAutotopicOnce()">â–¶ æ‰‹åŠ¨æ¨é€ä¸€æ¬¡</button>
            <div id="autotopic-result"></div>
                <div class="hint" style="margin:0;">ç”¨äºè°ƒè¯•/ç«‹åˆ»è·‘ä¸€è½®ï¼šä¼šç«‹å³åœ¨é£ä¹¦ç¾¤æ¨é€ä¸€æ¡â€œä»Šæ—¥é€‰é¢˜å€™é€‰â€æ¶ˆæ¯ã€‚</div>
            </div>

            <div class="form-group">
                <label>è¿è¡Œæ¨¡å¼</label>
                <select id="at_mode">
                    <option value="auto">è‡ªåŠ¨æ¨¡å¼ï¼ˆç›´æ¥ç”Ÿæˆå®Œæ•´å†…å®¹ï¼‰</option>
                    <option value="manual">äººå·¥ç¡®è®¤æ¨¡å¼ï¼ˆå…ˆç”Ÿæˆæ ‡é¢˜å€™é€‰ï¼Œäººå·¥é€‰æ‹©åå†ç”Ÿæˆï¼‰</option>
                </select>
                <div class="hint">è‡ªåŠ¨æ¨¡å¼ï¼šçƒ­ç‚¹â†’æ ‡é¢˜â†’å†…å®¹ä¸€æ­¥åˆ°ä½ã€‚äººå·¥ç¡®è®¤æ¨¡å¼ï¼šå…ˆå‡ºæ ‡é¢˜åˆ—è¡¨ï¼Œä½ é€‰å®šåå†ç”Ÿæˆå®Œæ•´å†…å®¹ã€‚</div>
            </div>

            <div class="row">
                <div class="col-3">
                    <div class="form-group">
                        <label>è‡ªåŠ¨æ¨¡å¼ - ç”Ÿæˆæ–‡ç« æ•°</label>
                        <input type="number" id="at_auto_count" min="1" max="10" value="3">
                    </div>
                </div>
                <div class="col-3">
                    <div class="form-group">
                        <label>ğŸ”¥ çƒ­ç‚¹ç±»æ ‡é¢˜æ•°</label>
                        <input type="number" id="at_hot_title_count" min="0" max="20" value="3">
                        <div class="hint">æ¯ä¸ªè´¦å·æ¨èå‡ ä¸ªçƒ­ç‚¹ç±»æ ‡é¢˜</div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="form-group">
                        <label>âœ¨ è‡ªä¸»é€‰é¢˜æ ‡é¢˜æ•°</label>
                        <input type="number" id="at_self_title_count" min="0" max="10" value="3">
                        <div class="hint">AI æ ¹æ®è´¦å·å®šä½è‡ªä¸»ç”Ÿæˆ</div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>å®šæ—¶è°ƒåº¦ (cron è¡¨è¾¾å¼)</label>
                <input type="text" id="at_schedule" value="0 9 * * *" placeholder="0 9 * * *">
                <div class="hint">ç¤ºä¾‹ï¼š0 9 * * * = æ¯å¤©9ç‚¹ï¼Œ0 9,18 * * * = æ¯å¤©9ç‚¹å’Œ18ç‚¹</div>
            </div>

            <div class="form-group">
                <label>æ—¶åŒº</label>
                <input type="text" id="at_timezone" value="Asia/Shanghai">
            </div>

            <div class="form-group">
                <label>çƒ­ç‚¹æ•°æ®æº</label>
                <div id="at_sources"></div>
                <div class="hint">é€‰æ‹©è¦æŠ“å–çš„çƒ­ç‚¹å¹³å°</div>
            </div>

            <div class="form-group">
                <label>æœç´¢å¼•æ“è¡¥å……</label>
                <select id="at_search_engine">
                    <option value="brave">Brave Search</option>
                    <option value="google">Google (éœ€é…ç½®)</option>
                    <option value="none">ä¸ä½¿ç”¨</option>
                </select>
                <div class="hint">ç”¨æœç´¢å¼•æ“è¡¥å……çƒ­ç‚¹çš„è¯¦ç»†å†…å®¹å’ŒèƒŒæ™¯ä¿¡æ¯</div>
            </div>

            <div class="form-group">
                <label>ç›®æ ‡å¹³å°</label>
                <div id="at_platforms"></div>
                <div class="hint">è‡ªåŠ¨é€‰é¢˜åç”Ÿæˆå“ªäº›å¹³å°çš„å†…å®¹</div>
            </div>

            <div class="form-group">
                <label>å…³é”®è¯è¿‡æ»¤ï¼ˆåªé€‰åŒ…å«è¿™äº›è¯çš„çƒ­ç‚¹ï¼Œç•™ç©º=ä¸é™ï¼‰</label>
                <input type="text" id="at_filter" placeholder="AI,ç§‘æŠ€,ç¼–ç¨‹ï¼ˆé€—å·åˆ†éš”ï¼‰">
            </div>

            <div class="form-group">
                <label>æ’é™¤å…³é”®è¯ï¼ˆè·³è¿‡åŒ…å«è¿™äº›è¯çš„çƒ­ç‚¹ï¼‰</label>
                <input type="text" id="at_exclude" placeholder="å¨±ä¹,å…«å¦ï¼ˆé€—å·åˆ†éš”ï¼‰">
            </div>

            <button class="btn btn-primary" onclick="saveAutotopic()">ğŸ’¾ ä¿å­˜è‡ªåŠ¨é€‰é¢˜é…ç½®</button>
        </div>

        <!-- Debug: è‡ªåŠ¨é€‰é¢˜ Prompt é¢„è§ˆ -->
        <details class="card" style="cursor:pointer;">
            <summary style="color:#f59e0b; font-weight:600; font-size:14px;">ğŸ”§ Debug: è‡ªåŠ¨é€‰é¢˜ Prompt é¢„è§ˆ</summary>
            <p style="color:#64748b; font-size:12px; margin:8px 0;">å±•ç¤ºè‡ªåŠ¨é€‰é¢˜æµç¨‹ä¸­å„ç¯èŠ‚çš„ promptã€‚<code style="color:#f59e0b;">{å ä½ç¬¦}</code> ä¸ºè¿è¡Œæ—¶åŠ¨æ€æ•°æ®ã€‚</p>
            <div class="form-group" style="margin-top:12px;">
                <label>é€‰æ‹©è´¦å·æŸ¥çœ‹å…¶ prompt</label>
                <select id="at_debug_account" onchange="updateAutotopicDebug()"></select>
            </div>
            <div id="at-debug-prompts"></div>
        </details>
    </div>

    <!-- ==================== é€‰é¢˜åº“ ==================== -->
    <div id="panel-topicbanks" class="panel">
        <div class="card">
            <h3>é€‰é¢˜åº“ï¼ˆæŒ‰è´¦å·ï¼‰</h3>
            <p style="color:#94a3b8; font-size:13px; margin-bottom:16px;">æ¯ä¸ªå·ç»‘å®šè‡ªå·±çš„é€‰é¢˜åº“ï¼Œç”¨äºè‡ªåŠ¨é€‰é¢˜ä¸â€œå»åŒè´¨åŒ–è½®æ¢â€ã€‚å»ºè®®åªç»´æŠ¤â€œç—›ç‚¹/åœºæ™¯/å†²çª/åŠ¨ä½œâ€çš„åŸå­ç´ æï¼Œä¸éœ€è¦æå‰ç”Ÿæˆæˆå“æ–‡ç« ã€‚</p>

            <div class="form-group">
                <label>é€‰æ‹©è´¦å·</label>
                <select id="tb_account" onchange="loadTopicBank()"></select>
                <div class="hint">ä¸åŒè´¦å·å¯¹åº”ä¸åŒæ–‡ä»¶ï¼šconfig/topic_banks/&lt;account_id&gt;.json</div>
            </div>

            <div class="form-group">
                <label>é€‰é¢˜åº“ JSON</label>
                <textarea id="tb_json" style="min-height:360px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;" placeholder="{ ... }"></textarea>
                <div class="hint">æ”¯æŒç›´æ¥ç¼–è¾‘ä¿å­˜ï¼›ä¿å­˜åä¼šæ›´æ–° updated_at å­—æ®µã€‚</div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn btn-secondary" onclick="loadTopicBank()">åˆ·æ–°</button>
                <button class="btn btn-primary" onclick="saveTopicBank()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ==================== çˆ†æ¬¾åº“ï¼ˆBenchmarksï¼‰ ==================== -->
    <div id="panel-bench" class="panel">
        <div class="card">
            <h3>çˆ†æ¬¾åº“</h3>
            <p style="color:#94a3b8; font-size:13px;">å…ˆè·‘é€šâ€œæ‰‹åŠ¨æŠ•å–‚â†’è§£æâ†’å…¥åº“â€ã€‚å½“å‰ç‰ˆæœ¬æš‚ç”¨ 01 å…¥åº“ä½œä¸ºå ä½ï¼›ä¸‹ä¸€ç‰ˆä¼šåŠ  URL/æ–‡æœ¬/PDF ä¸‰ç§å…¥å£ + è‡ªåŠ¨æ‹†è§£ï¼ˆåˆ†ç±»/æ–‡é£/ç»“æ„/çˆ†æ¬¾è¦ç´ ï¼‰å¹¶æ²‰æ·€åˆ†ç±» promptã€‚</p>
        </div>
        <div class="row">
            <div class="col-8"><div class="card">
                    <h3>01ï½œç´ æèµ„äº§åŒ–ï¼ˆIdeas / Inspirationsï¼‰</h3>
                    <div class="form-group">
                        <label>æ–°å¢çµæ„Ÿ</label>
                        <textarea id="pipe_insp_text" placeholder="ä¸€å¥è¯ç´ æï¼šå…·ä½“åœºæ™¯/å†²çª/åå¸¸è¯†ç‚¹ï¼ˆè¶Šå…·ä½“è¶Šå¥½ï¼‰"></textarea>
                        <div class="hint">å†™å…¥ data/gzh/inspirations.jsonlï¼ˆappend-onlyï¼‰ã€‚</div>
                    </div></div>
            <div class="col-4"><div class="col-4">
                <div class="card">
                    <h3>03ï½œSOP/è´¨é‡/å»é‡é…ç½®</h3>
                    <div class="form-group">
                        <label>ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆ0~1ï¼‰</label>
                        <input id="pipe_dedup_th" placeholder="0.82" />
                        <div class="hint">ä»…ç”¨äºæ ‡è®°/é¢„è­¦ï¼ˆå½“å‰æœ€å°è·¯å¾„é»˜è®¤ warnï¼‰ã€‚</div>
                    </div></div>
        </div>
    </div>

<!-- ==================== é€‰é¢˜åº“ï¼ˆæ–°æµç¨‹ï¼‰ ==================== -->
    <div id="panel-topics2" class="panel">
        <div class="card">
            <h3>é€‰é¢˜åº“</h3>
            <p style="color:#94a3b8; font-size:13px;">æ”¯æŒâ€œå†ç”Ÿäº§â€ä¸æ–­ä¸°å¯Œé€‰é¢˜åº“ï¼ˆè½åº“å¹¶è·³è¿‡ç²¾ç¡®é‡å¤ï¼‰ã€‚</p>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                <button class="btn btn-primary btn-sm" onclick="pipelineIncubateTopics()">å†ç”Ÿäº§é€‰é¢˜ï¼ˆè½åº“ï¼‰</button>
                <button class="btn btn-secondary btn-sm" onclick="pipelineLoad('topics')">åˆ·æ–°</button>
            </div>
        </div>
        <div class="card">
                    <h3>02ï½œç»“æ„åŒ–é€‰é¢˜æ± ï¼ˆTopicsï¼š7å¸¸è§„+5çƒ­ç‚¹ï¼‰</h3>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                        <button class="btn btn-secondary btn-sm" onclick="pipelineLoad('topics')">åˆ·æ–°</button>
                    </div>
    </div>

<!-- ==================== å†…å®¹æ’°å†™ ==================== -->
    <div id="panel-write" class="panel">
        <div class="card">
            <h3>å†…å®¹æ’°å†™</h3>
            <p style="color:#94a3b8; font-size:13px;">è¿™é¡µä¼šæ‰¿æ¥â€œé€‰é¢˜â†’å†™ä½œâ†’å…¥è‰ç¨¿åº“â€çš„ä¸»æµç¨‹ã€‚å½“å‰å…ˆæŠŠ SOP/è´¨é‡/å»é‡é…ç½®æ”¾åœ¨è¿™é‡Œï¼Œå¹¶é€æ­¥æŠŠ Jobs çš„ç”Ÿæˆæµç¨‹è¿ç§»è¿›æ¥ã€‚</p>
        </div>
        <div class="row">
            <div class="col-8">
                <div class="card">
                    <h3>ç”Ÿæˆå…¥å£ï¼ˆè¿ç§»ä¸­ï¼‰</h3>
                    <p style="color:#94a3b8; font-size:13px; line-height:1.8;">ä¸´æ—¶ç”¨æ³•ï¼šå…ˆåœ¨ã€Œé€‰é¢˜åº“ã€é€‰ä¸€ä¸ªä¸»é¢˜ï¼Œç„¶ååˆ°ã€ŒJobsã€ç”Ÿæˆå¹¶å‹¾é€‰æ¨è‰ç¨¿ç®±ã€‚æˆ‘ä¼šæŠŠâ€œä»é€‰é¢˜åº“ä¸€é”®å¸¦å…¥ç”Ÿæˆâ€åšæˆè¿™é‡Œçš„ä¸»æŒ‰é’®ã€‚</p>
                </div>
            </div>
            <div class="col-4"><div class="col-4">
                <div class="card">
                    <h3>03ï½œSOP/è´¨é‡/å»é‡é…ç½®</h3>
                    <div class="form-group">
                        <label>ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆ0~1ï¼‰</label>
                        <input id="pipe_dedup_th" placeholder="0.82" />
                        <div class="hint">ä»…ç”¨äºæ ‡è®°/é¢„è­¦ï¼ˆå½“å‰æœ€å°è·¯å¾„é»˜è®¤ warnï¼‰ã€‚</div>
                    </div></div>
        </div>
    </div>

<!-- ==================== åº“å­˜ï¼ˆDrafts/Publishedï¼‰ ==================== -->
    <div id="panel-inventory" class="panel">
        <div class="card">
            <h3>åº“å­˜</h3>
            <p style="color:#94a3b8; font-size:13px;">åŒ…å«è‰ç¨¿åº“ï¼ˆ03ï¼‰ä¸å·²å‘å¸ƒï¼ˆ04ï¼‰ã€‚</p>
        </div>
        <div class="card">
                    <h3>03ï½œè‰ç¨¿åº“ï¼ˆDraftsï¼‰</h3>
                    <div class="hint" style="margin:-6px 0 10px 0;">æ¥è‡ª data/gzh/drafts.jsonlï¼ˆç®¡çº¿è‰ç¨¿ï¼‰ä¸ output/ï¼ˆç”Ÿæˆç»“æœï¼‰ã€‚</div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                        <button class="btn btn-secondary btn-sm" onclick="pipelineLoad('drafts')">åˆ·æ–°ç®¡çº¿è‰ç¨¿åº“</button>
                    </div>
        <div class="card">
                    <h3>04ï½œå·²å‘å¸ƒå½’æ¡£ï¼ˆPublishedï¼‰</h3>
                    <div class="form-group">
                        <label>æ‰‹åŠ¨å½’æ¡£ï¼ˆæœ€å°å¯ç”¨ï¼‰</label>
                        <input id="pipe_pub_account" placeholder="account_idï¼Œä¾‹å¦‚ mp_chaguan" />
                        <div class="hint">è´¦å· id å¯åœ¨ Accounts é¡µæŸ¥çœ‹ã€‚</div>
                    </div>
    </div>


    <!-- ==================== Trend ==================== -->
    <div id="panel-hot" class="panel">
        <div style="display:flex; gap:10px; margin-bottom:16px; align-items:center; flex-wrap:wrap;">
            <input type="text" id="hot-search" placeholder="æœç´¢çƒ­ç‚¹å…³é”®è¯..." style="flex:1; min-width:200px; padding:10px 14px; background:#0f172a; border:1px solid #334155; border-radius:8px; color:#e2e8f0; font-size:14px; outline:none;">
            <button class="btn btn-primary btn-sm" onclick="loadHot()">æœç´¢</button>
            <button class="btn btn-secondary btn-sm" onclick="hotNav(-1)">â† å‰ä¸€å¤©</button>
            <span id="hot-date" style="color:#60a5fa; font-size:14px; font-weight:600;"></span>
            <button class="btn btn-secondary btn-sm" onclick="hotNav(1)">åä¸€å¤© â†’</button>
            <select id="hot-date-select" onchange="hotCurrentDate=this.value;loadHot()" style="padding:6px 10px; background:#0f172a; border:1px solid #334155; border-radius:8px; color:#e2e8f0; font-size:13px;"></select>
        </div>
        <div id="hot-content"><div class="card"><div style="padding:20px; text-align:center; color:#64748b;">åŠ è½½ä¸­...</div></div></div>
    </div>

    <!-- ==================== Stats ==================== -->
    <div id="panel-stats" class="panel">
        <div class="card">
            <h3>å·²å‘å¸ƒæ–‡ç« ç»Ÿè®¡</h3>
            <p style="color:#94a3b8; font-size:13px; margin-bottom:12px;">å±•ç¤ºå…¬ä¼—å·å·²å‘å¸ƒçš„æ–‡ç« æ•°æ®ã€‚</p>
            <div class="form-group">
                <label>é€‰æ‹©å…¬ä¼—å·è´¦å·</label>
                <select id="stats_account" onchange="loadStats()">
                    <option value="">ï¼ˆä½¿ç”¨å…¨å±€é…ç½®ï¼‰</option>
                </select>
            </div>
            <div id="stats-summary" style="display:flex; gap:16px; margin-bottom:20px;"></div>
            <div id="stats-list"></div>
        </div>
    </div>

    <!-- ==================== Settings (å…¨å±€) ==================== -->
    <div id="panel-settings" class="panel">
        <div class="card">
            <h3>å…¨å±€è®¾ç½®</h3>
            <p style="color:#94a3b8; font-size:13px; margin-bottom:16px;">æ··å…ƒå›¾ç‰‡ç”Ÿæˆç­‰å…¨å±€é…ç½®ã€‚å…¬ä¼—å·å‡­è¯å·²ç§»åˆ° Accounts é¡µé¢éšè´¦å·é…ç½®ã€‚</p>
            <div class="row">
                <div class="col-8">
                    <div class="card" style="background:#0f172a;">
                        <h3>è…¾è®¯æ··å…ƒé…ç½®</h3>
                        <div class="form-group"><label>Secret ID</label><input type="text" id="cfg_hunyuan_secret_id" placeholder="AKID..."></div>
                        <div class="form-group"><label>Secret Key</label><input type="password" id="cfg_hunyuan_secret_key" placeholder="****"></div>
                        <div class="form-group"><label>Region</label><input type="text" id="cfg_hunyuan_region" placeholder="ap-guangzhou"></div>
                    </div>
                </div>
                <div class="col-4">
                    <button class="btn btn-primary" onclick="saveConfig()" style="width:100%;">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <div style="color:#64748b; font-size:12px; margin-top:10px; line-height:1.6;">
                        å›¾ç‰‡ç”Ÿæˆç›¸å…³é…ç½®å·²è¿ç§»åˆ° <strong style="color:#94a3b8;">Profiles</strong>ï¼ˆæŒ‰è´¦å·ç®¡ç†ï¼‰ã€‚
                    </div>
                </div>
            </div>
        </div>

        <!-- å†™ä½œé£æ ¼ç¼–è¾‘å™¨ -->
        <div class="card">
            <h3>âœï¸ å†™ä½œé£æ ¼æ¨¡æ¿</h3>
            <p style="color:#94a3b8; font-size:13px; margin-bottom:16px;">
                ç®¡ç†å¯å¤ç”¨çš„å†™ä½œé£æ ¼ã€‚æ¯ä¸ªé£æ ¼åŒ…å«ä¸€æ®µ<strong>é£æ ¼æè¿°</strong>ï¼Œç”Ÿæˆæ–‡ç« æ—¶ AI ä¼šå‚è€ƒæ­¤æè¿°æ¥å†³å®šè¯­æ°”ã€ç»“æ„å’Œè¡¨è¾¾æ–¹å¼ã€‚
                åœ¨ Profiles é¡µé¢ä¸ºè´¦å·é€‰æ‹©é£æ ¼å³å¯å¯ç”¨ã€‚
            </p>
            <div style="margin-bottom:12px;">
                <label style="color:#94a3b8; font-size:12px;">å¿«é€Ÿå¯¼å…¥é¢„è®¾ï¼š</label>
                <button class="btn btn-secondary btn-sm" onclick="importPresetStyle('dan-koe')" style="margin-left:8px;">ğŸ“¥ Dan Koe é£æ ¼</button>
            </div>
            <div id="styles-list"></div>
            <button class="btn btn-secondary btn-sm" onclick="addWritingStyle()" style="margin-top:12px;">ï¼‹ æ–°å¢é£æ ¼</button>
        </div>

        <!-- é…ç½®å¤‡ä»½ä¸æ¢å¤ -->
        <div class="card">
            <h3>ğŸ’¾ é…ç½®å¤‡ä»½ä¸æ¢å¤</h3>
            <p style="color:#94a3b8; font-size:13px; margin-bottom:16px;">
                ä¸€é”®å¯¼å‡ºå…¨éƒ¨ç³»ç»Ÿé…ç½®ï¼ˆå…¨å±€è®¾ç½® + è´¦å· + å†™ä½œé£æ ¼ + è‡ªåŠ¨é€‰é¢˜ï¼‰ï¼Œæˆ–ä»ä¹‹å‰å¯¼å‡ºçš„æ–‡ä»¶æ¢å¤ã€‚
            </p>
            <div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
                <div style="flex:1; min-width:200px;">
                    <button class="btn btn-primary" onclick="exportConfig()" style="width:100%;">
                        ğŸ“¦ ä¸€é”®å¯¼å‡ºé…ç½®
                    </button>
                    <div style="color:#64748b; font-size:12px; margin-top:8px;">
                        å¯¼å‡ºä¸º JSON æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰é…ç½®é¡¹
                    </div>
                </div>
                <div style="flex:1; min-width:200px;">
                    <label class="btn btn-secondary" style="width:100%; text-align:center; cursor:pointer; display:block;">
                        ğŸ“‚ ä¸Šä¼ é…ç½®æ¢å¤
                        <input type="file" id="import-file" accept=".json" onchange="importConfig(this)" style="display:none;">
                    </label>
                    <div style="color:#64748b; font-size:12px; margin-top:8px;">
                        ä¸Šä¼ ä¹‹å‰å¯¼å‡ºçš„ JSON æ–‡ä»¶ï¼Œæ¢å¤å…¨éƒ¨é…ç½®ï¼ˆæ—§é…ç½®è‡ªåŠ¨å¤‡ä»½ï¼‰
                    </div>
                </div>
            </div>
            <div id="backup-result" style="margin-top:12px;"></div>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
const API = '/art/api';
let selectedTheme = 'snow-cold';
let layoutSelectedTheme = 'snow-cold';

let wechatThemesCache = null;
let xhsThemesCache = null;

async function getWechatThemes() {
  if (wechatThemesCache) return wechatThemesCache;
  const res = await fetch(API + '/themes?platform=wechat_mp');
  wechatThemesCache = await res.json();
  return wechatThemesCache;
}

async function getXhsThemes() {
  if (xhsThemesCache) return xhsThemesCache;
  const res = await fetch(API + '/themes?platform=xhs');
  xhsThemesCache = await res.json();
  return xhsThemesCache;
}

function getPlatformOfAccount(accountId) {
  const acc = accountsCache.find(a=>a.id===accountId);
  return acc?.platform || 'wechat_mp';
}

async function renderJobThemeGrid() {
  const accId = document.getElementById('job_account')?.value || '';
  const platform = getPlatformOfAccount(accId);

  if (platform === 'xhs') {
    const themes = await getXhsThemes();
    renderThemeGrid('themes-grid', themes, selectedTheme, k => { selectedTheme = k; renderJobThemeGrid(); });
    return;
  }

  const themes = await getWechatThemes();
  renderThemeGrid('themes-grid', themes, selectedTheme, k => { selectedTheme = k; renderJobThemeGrid(); });
}

function onJobAccountChange(){
  // Reset theme when switching platforms (avoid invalid selection)
  const accId = document.getElementById('job_account')?.value || '';
  const platform = getPlatformOfAccount(accId);
  if (platform === 'xhs') {
    // async load xhs themes then select first
    getXhsThemes().then(t=>{
      selectedTheme = Object.keys(t||{})[0] || selectedTheme;
      renderJobThemeGrid();
    });
    return;
  }
  selectedTheme = 'snow-cold';
  renderJobThemeGrid();
}

const LAYOUT_LABELS = {card:'å¡ç‰‡',magazine:'æ‚å¿—',minimal:'æç®€',gradient:'æ¸å˜',xhs:'å°çº¢ä¹¦'};

function switchTab(name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('panel-' + name).classList.add('active');
    if (name === 'hot') loadHot();
    if (name === 'settings') { loadConfig(); loadWritingStyles(); }
    if (name === 'accounts') loadAccounts();
    if (name === 'profiles') { loadWritingStyles().then(() => loadAccounts(true)); }
    if (name === 'layouts') loadLayoutThemes();
    if (name === 'jobs') loadDrafts();
    if (name === 'autotopic') { loadAutotopic(); refreshAutotopicDebugAccounts(); }
    if (name === 'topicbanks') { loadAccountsForTopicBanks(); }
    if (name === 'stats') { loadAccountsForStats(); loadStats(); }
    if (name === 'pipeline') { pipelineLoadSettings(); pipelineRefreshAll(); }
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 3000);
}

// ==================== Themes ====================
function renderThemeGrid(containerId, themes, selected, onSelect) {
    const grid = document.getElementById(containerId);
    if (!grid) return;
    grid.innerHTML = '';
    for (const [key, val] of Object.entries(themes)) {
        const layout = val.layout || 'card';
        const div = document.createElement('div');
        div.className = 'theme-card' + (key === selected ? ' selected' : '');
        div.style.background = val.bg;
        div.onclick = () => onSelect(key);
        div.innerHTML = `<div class="theme-dot" style="background:${val.primary}"></div><div class="theme-name" style="color:${val.primary}">${val.name}</div><div class="theme-layout-tag">${LAYOUT_LABELS[layout]||layout}</div>`;
        grid.appendChild(div);
    }
}
async function loadThemes() {
    // Jobs theme grid is platform-aware; do not load everything into one mixed list
    await renderJobThemeGrid();
}

// ==================== Generate ====================
async function generateArticle() {
    const keyword = document.getElementById('keyword').value.trim();
    if (!keyword) { showToast('è¯·è¾“å…¥å…³é”®è¯'); return; }
    const res = await fetch(API + '/generate', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            keyword, theme: selectedTheme,
            num_images: parseInt(document.getElementById('num_images').value),
            extra_prompt: document.getElementById('extra_prompt').value.trim(),
            account_id: document.getElementById('job_account')?.value || '',
            push_to_draft: document.getElementById('push_to_draft')?.checked || false
        })
    });
    const data = await res.json();
    const bar = document.getElementById('status-bar');
    bar.className = 'status-bar status-pending';
    bar.textContent = 'â³ ' + data.message;
    showToast('ä»»åŠ¡å·²æäº¤ï¼');
    pollStatus();
}

async function pollStatus() {
    const res = await fetch(API + '/status');
    const data = await res.json();
    const bar = document.getElementById('status-bar');
    if (data.status === 'done') {
        bar.className = 'status-bar status-done';
        bar.textContent = 'âœ… æ–‡ç« å·²ç”Ÿæˆï¼' + (data.title ? ` æ ‡é¢˜ï¼š${data.title}` : '');
        loadDrafts();
    } else if (data.status === 'processing' || data.status === 'pending') {
        bar.className = 'status-bar status-pending';
        bar.textContent = 'â³ ' + (data.step || 'AI æ­£åœ¨ç”Ÿæˆä¸­...ï¼ˆçº¦3-5åˆ†é’Ÿï¼‰');
        setTimeout(pollStatus, 8000);
    } else if (data.status === 'error') {
        bar.className = 'status-bar status-idle';
        bar.textContent = 'âŒ å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯');
    } else {
        bar.className = 'status-bar status-idle';
        bar.textContent = 'ç³»ç»Ÿå°±ç»ª';
    }
}

// ==================== Hot ====================
let hotCurrentDate = new Date().toISOString().slice(0,10);
let hotDates = [];

async function loadHot() {
    const q = document.getElementById('hot-search')?.value?.trim() || '';
    try {
        const res = await fetch(API + `/hot?date=${hotCurrentDate}&top=10${q ? '&q='+encodeURIComponent(q) : ''}`);
        const data = await res.json();
        hotDates = data.dates || []; hotCurrentDate = data.current_date || hotCurrentDate;
        document.getElementById('hot-date').textContent = hotCurrentDate;
        const sel = document.getElementById('hot-date-select');
        sel.innerHTML = hotDates.map(d => `<option value="${d}" ${d===hotCurrentDate?'selected':''}>${d}</option>`).join('');
        const platforms = data.platforms || {};
        const content = document.getElementById('hot-content');
        if (!Object.keys(platforms).length) { content.innerHTML = `<div class="card"><div style="padding:20px; text-align:center; color:#64748b;">${data.message || 'æš‚æ— æ•°æ®'}</div></div>`; return; }
        let html = '<div class="row" style="flex-wrap:wrap; gap:16px;">';
        for (const [pname, items] of Object.entries(platforms)) {
            html += `<div style="flex:1; min-width:320px;"><div class="card"><h3 style="font-size:14px;">ğŸ“Œ ${pname}</h3><ul class="hot-list" style="padding:0 16px;">`;
            items.forEach(item => {
                const title = q ? item.title.replace(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'gi'), m => `<span style="color:#f59e0b">${m}</span>`) : item.title;
                html += `<li class="hot-item"><span class="hot-title" onclick="useHot('${item.title.replace(/'/g,"\\'")}')">${item.rank}. ${title}</span><button class="btn btn-secondary btn-sm" onclick="useHot('${item.title.replace(/'/g,"\\'")}')">ç”¨è¿™ä¸ª</button></li>`;
            });
            html += '</ul></div></div>';
        }
        content.innerHTML = html + '</div>';
    } catch(e) { showToast('çƒ­ç‚¹åŠ è½½å¤±è´¥: ' + e.message); }
}
function hotNav(dir) { const idx = hotDates.indexOf(hotCurrentDate); const n = idx - dir; if (n >= 0 && n < hotDates.length) { hotCurrentDate = hotDates[n]; loadHot(); } }
document.getElementById('hot-search')?.addEventListener('keydown', e => { if (e.key === 'Enter') loadHot(); });
function useHot(title) { document.getElementById('keyword').value = title; switchTab('jobs'); showToast('å·²å¡«å…¥å…³é”®è¯'); }

// ==================== Drafts ====================
let draftsPage = 1;
const draftsLimit = 10;

async function loadDrafts(page = draftsPage) {
    draftsPage = page;
    const res = await fetch(API + `/drafts?page=${draftsPage}&limit=${draftsLimit}`);
    const payload = await res.json();
    const drafts = payload.items || [];
    const total = payload.total || 0;
    const list = document.getElementById('draft-list');
    if (!list) return;

    const totalPages = Math.max(1, Math.ceil(total / draftsLimit));

    const pager = `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; color:#94a3b8; font-size:12px;">
        <div>å…± ${total} ç¯‡ Â· ç¬¬ ${draftsPage}/${totalPages} é¡µ</div>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-secondary btn-sm" onclick="loadDrafts(1)" ${draftsPage<=1?'disabled':''}>é¦–é¡µ</button>
          <button class="btn btn-secondary btn-sm" onclick="loadDrafts(draftsPage-1)" ${draftsPage<=1?'disabled':''}>ä¸Šä¸€é¡µ</button>
          <button class="btn btn-secondary btn-sm" onclick="loadDrafts(draftsPage+1)" ${draftsPage>=totalPages?'disabled':''}>ä¸‹ä¸€é¡µ</button>
          <button class="btn btn-secondary btn-sm" onclick="loadDrafts(totalPages)" ${draftsPage>=totalPages?'disabled':''}>æœ«é¡µ</button>
        </div>
      </div>`;

    list.innerHTML = pager + (drafts.map(d => {
        const date = new Date(d.modified * 1000).toLocaleString('zh-CN');
        const title = d.title || d.name;
        const digest = d.digest ? `<div style="color:#64748b; font-size:12px; margin-top:4px;">${d.digest}</div>` : '';
        const accTag = d.account_id ? `<span style="background:#1e3a5f; color:#60a5fa; padding:2px 8px; border-radius:4px; font-size:11px; margin-left:8px;">${d.account_id}</span>` : '';
        return `<div class="draft-item" id="draft-item-${d.name}" onclick="selectDraft('${d.name}')" style="cursor:pointer; flex-wrap:wrap; gap:10px; align-items:flex-start;">
            <div style="flex:1; min-width:260px;">
                <div style="font-weight:700;">ğŸ“„ ${title}${accTag}</div>
                ${digest}
                <div style="color:#64748b; font-size:12px; margin-top:6px;">æ›´æ–°æ—¶é—´ï¼š${date} Â· æ–‡ä»¶ï¼š${Math.round(d.size/1024)}KB</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
                <button class="btn btn-secondary btn-sm" onclick="openDraftDebug('${d.name}')">Debug</button>
                <a href="${API}/preview/${d.name}" target="_blank" class="btn btn-secondary btn-sm">é¢„è§ˆ</a>
                <button class="btn btn-danger btn-sm" onclick="deleteDraft('${d.name}', '${(title||'').replace(/'/g,"\\'")}')">åˆ é™¤</button>
            </div>
        </div>`;
    }).join(''));

    if (!drafts.length) {
      list.innerHTML = pager + '<div style="color:#94a3b8; padding:12px;">æš‚æ— è‰ç¨¿</div>';
    }
}

async function deleteDraft(name, title) {
    const ok = confirm(`ç¡®è®¤åˆ é™¤ï¼Ÿ\n\n${title || name}\n\nï¼ˆä¼šç§»åŠ¨åˆ° output/.trashï¼Œå¯æ¢å¤ï¼‰`);
    if (!ok) return;
    try {
        const res = await fetch(API + `/drafts/${encodeURIComponent(name)}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
            showToast('å·²åˆ é™¤ï¼ˆå·²ç§»å…¥ .trashï¼‰âœ…');
            loadDrafts(draftsPage);
        } else {
            showToast('åˆ é™¤å¤±è´¥: ' + (data.error || 'unknown'));
        }
    } catch (e) {
        showToast('åˆ é™¤å¤±è´¥: ' + e.message);
    }
}

function closeDraftDebug() {
    const m = document.getElementById('draft-debug-modal');
    if (m) m.style.display = 'none';
}

async function openDraftDebug(name) {
    const m = document.getElementById('draft-debug-modal');
    const body = document.getElementById('draft-debug-body');
    if (!m || !body) return;
    m.style.display = 'block';
    body.innerHTML = '<div style="color:#94a3b8;">åŠ è½½ä¸­...</div>';

    try {
        const res = await fetch(API + `/drafts/${encodeURIComponent(name)}/debug`);
        const data = await res.json();
        if (!data.success) {
            body.innerHTML = `<div style="color:#fca5a5;">${data.error || 'åŠ è½½å¤±è´¥'}</div>`;
            return;
        }
        const meta = data.meta || {};
        const pipe = data.pipeline || {};
        const task = data.task || {};
        const dbg = (data.debug || {});
        const final = (dbg.final || {});
        const prompts = (dbg.prompts || {});
        const style = (dbg.style || {});
        const images = (dbg.images || {});
        const wechatDraft = (dbg.wechat_draft || {});

        const block = (title, content) => `
            <div style="margin-bottom:14px;">
                <div style="font-weight:700; color:#60a5fa; margin-bottom:6px;">${title}</div>
                <pre style="white-space:pre-wrap; background:#0f172a; border:1px solid #334155; border-radius:10px; padding:12px; font-size:12px; line-height:1.6; color:#e2e8f0;">${content || ''}</pre>
            </div>`;

        const info = `æ ‡é¢˜ï¼š${final.title || meta.title || ''}\nè´¦å·ï¼š${final.account_id || meta.account_id || ''}\næ¥æºï¼š${final.source_platform || ''} ${final.source_topic ? 'Â· ' + final.source_topic : ''}\nä¸»é¢˜æ¨¡æ¿(theme)ï¼š${final.theme || meta.theme || pipe.theme || task.theme || ''}\nåˆ›å»ºï¼š${final.created_at || meta.created_at || pipe.created_at || ''}\nå®Œæˆï¼š${final.done_at || ''}`;

        const articlePrompt = prompts.article_prompt || task.article_prompt || '';
        const titlePrompt = prompts.title_prompt || task.title_prompt || '';
        const coverPrompt = prompts.cover_prompt || '';
        const inlinePrompts = (prompts.inline_prompts || []).map((x,i)=>`[${i+1}] after_section=${x.after_section}\n${x.prompt}`).join('\n\n');

        const styleInfo = `style_prefixï¼š${style.style_prefix || ''}\ninline_prompt_extraï¼š${style.inline_prompt_extra || ''}\ninline_countï¼š${style.inline_count ?? ''}\ncover_resolutionï¼š${style.cover_resolution ?? ''}\ninline_resolutionï¼š${style.inline_resolution ?? ''}`;

        const uploadInfo = `cover_upload_errorï¼š${images.cover_upload_error || ''}\ninline_upload_errorsï¼š${JSON.stringify(images.inline_upload_errors || [], null, 2)}\n\ncover_uploadï¼š${JSON.stringify(images.cover_upload || {}, null, 2)}\n\ninline_uploadsï¼š${JSON.stringify(images.inline_uploads || [], null, 2)}`;

        const draftInfo = JSON.stringify(wechatDraft || {}, null, 2);

        body.innerHTML = [
            block('ä¿¡æ¯', info),
            block('ç”Ÿæˆæ ‡é¢˜ Promptï¼ˆtitle_promptï¼‰', titlePrompt || '(æ— /æœªè®°å½•)'),
            block('ç”Ÿæˆæ–‡ç«  Promptï¼ˆarticle_promptï¼‰', articlePrompt || '(æœªæ‰¾åˆ°ï¼šè¯¥æ–‡ç« å¯èƒ½ä¸æ˜¯é€šè¿‡ pending_tasks ç”Ÿæˆï¼Œæˆ–å·²è¢«æ¸…ç†)'),
            block('é¦–å›¾ Promptï¼ˆcover_promptï¼‰', coverPrompt || '(æ— )'),
            block('æ’å›¾ Promptsï¼ˆinline_promptsï¼‰', inlinePrompts || '(æ— )'),
            block('é£æ ¼/æ¨¡æ¿ä¿¡æ¯', styleInfo),
            block('ä¸Šä¼ /æ’å›¾æ’å…¥ä¿¡æ¯', uploadInfo),
            block('å¾®ä¿¡è‰ç¨¿è¿”å›ï¼ˆdraftï¼‰', draftInfo),
            block('Pipeline Debugï¼ˆåŸå§‹ï¼‰', JSON.stringify(pipe, null, 2)),
        ].join('');

    } catch (e) {
        body.innerHTML = `<div style="color:#fca5a5;">åŠ è½½å¤±è´¥ï¼š${e.message}</div>`;
    }
}

// ==================== Config ====================
async function loadConfig() {
    const res = await fetch(API + '/config'); const cfg = await res.json();
    document.getElementById('cfg_hunyuan_secret_id').value = cfg.hunyuan_secret_id || '';
    document.getElementById('cfg_hunyuan_secret_key').value = cfg.hunyuan_secret_key || '';
    document.getElementById('cfg_hunyuan_region').value = cfg.hunyuan_region || '';
}
async function saveConfig() {
    const cfg = {
        hunyuan_secret_id: document.getElementById('cfg_hunyuan_secret_id').value,
        hunyuan_secret_key: document.getElementById('cfg_hunyuan_secret_key').value,
        hunyuan_region: document.getElementById('cfg_hunyuan_region').value,
    };
    const res = await fetch(API + '/config', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(cfg) });
    const data = await res.json();
    showToast(data.success ? 'å·²ä¿å­˜ âœ…' : 'ä¿å­˜å¤±è´¥');
}

async function exportConfig() {
    try {
        const res = await fetch(API + '/export');
        const blob = await res.blob();
        const cd = res.headers.get('Content-Disposition') || '';
        const match = cd.match(/filename="?([^"]+)"?/);
        const filename = match ? match[1] : `artbot-config-${new Date().toISOString().slice(0,10)}.json`;
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
        showToast('é…ç½®å·²å¯¼å‡º ğŸ“¦');
    } catch(e) {
        showToast('å¯¼å‡ºå¤±è´¥: ' + e.message);
    }
}

async function importConfig(input) {
    const file = input.files[0];
    if (!file) return;
    const resultDiv = document.getElementById('backup-result');
    
    if (!confirm(`ç¡®å®šè¦ä» "${file.name}" æ¢å¤é…ç½®å—ï¼Ÿ\nå½“å‰é…ç½®ä¼šè‡ªåŠ¨å¤‡ä»½ã€‚`)) {
        input.value = '';
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        const res = await fetch(API + '/import', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
            resultDiv.innerHTML = `<div style="color:#4ade80; padding:8px; background:#0f2918; border-radius:6px;">
                âœ… ${data.message}<br>
                <span style="font-size:12px;">å·²æ¢å¤: ${data.restored.join(', ')}</span>
            </div>`;
            showToast('é…ç½®å·²æ¢å¤ âœ…');
            // Reload current page data
            loadConfig();
            loadWritingStyles();
        } else {
            resultDiv.innerHTML = `<div style="color:#f87171; padding:8px; background:#2a0f0f; border-radius:6px;">âŒ ${data.error}</div>`;
        }
    } catch(e) {
        resultDiv.innerHTML = `<div style="color:#f87171; padding:8px;">âŒ ${e.message}</div>`;
    }
    input.value = '';
}

// ==================== Writing Styles ====================
let accountsCache = [];
let writingStylesCache = [];

async function loadWritingStyles() {
    const res = await fetch(API + '/writing_styles');
    writingStylesCache = await res.json();
    renderStylesList();
}

async function saveWritingStyles() {
    await fetch(API + '/writing_styles', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(writingStylesCache),
    });
    showToast('é£æ ¼æ¨¡æ¿å·²ä¿å­˜ âœ…');
}

function renderStylesList() {
    const box = document.getElementById('styles-list');
    if (!box) return;
    if (!writingStylesCache.length) {
        box.innerHTML = '<div style="color:#64748b; padding:12px;">æš‚æ— é£æ ¼æ¨¡æ¿ã€‚ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ï¼Œæˆ–å¯¼å…¥é¢„è®¾ã€‚</div>';
        return;
    }
    box.innerHTML = writingStylesCache.map((ws, i) => {
        return `<div class="card" style="background:#0f172a; margin-bottom:12px;">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                <input value="${ws.name||''}" placeholder="é£æ ¼åç§°ï¼ˆå¦‚ï¼šDan Koe é£æ ¼ï¼‰"
                    oninput="writingStylesCache[${i}].name=this.value"
                    style="flex:1; font-weight:600; font-size:15px;">
                <button class="btn btn-secondary btn-sm" onclick="removeWritingStyle(${i})" style="color:#ef4444;">âœ• åˆ é™¤</button>
            </div>
            <div style="flex:1;">
                <label style="color:#94a3b8; font-size:12px; margin-bottom:6px; display:block;">é£æ ¼æè¿°ï¼ˆç”Ÿæˆæ–‡ç« æ—¶ AI ä¼šå‚è€ƒæ­¤æè¿°ï¼‰</label>
                <textarea rows="12" style="width:100%; font-size:13px; line-height:1.6;"
                    oninput="writingStylesCache[${i}].description=this.value"
                    placeholder="æè¿°è¿™ä¸ªé£æ ¼çš„å†™ä½œç‰¹ç‚¹ã€æ–‡ç« ç»“æ„ã€è¯­æ°”è¦æ±‚ã€æ ‡é¢˜å…¬å¼ç­‰...&#10;&#10;AI ç”Ÿæˆæ–‡ç« æ—¶ä¼šå‚è€ƒæ­¤æè¿°æ¥å†³å®šè¯­æ°”ã€ç»“æ„å’Œè¡¨è¾¾æ–¹å¼ã€‚"
                >${ws.description||''}</textarea>
            </div>
            <div style="margin-top:8px; display:flex; justify-content:flex-end;">
                <button class="btn btn-primary btn-sm" onclick="saveWritingStyles()">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>`;
    }).join('');
}

function addWritingStyle() {
    const id = 'style_' + Date.now().toString(36);
    writingStylesCache.push({ id, name: '', articles: [] });
    renderStylesList();
}

function removeWritingStyle(i) {
    if (!confirm('ç¡®å®šåˆ é™¤æ­¤é£æ ¼ï¼Ÿ')) return;
    writingStylesCache.splice(i, 1);
    saveWritingStyles();
    renderStylesList();
}

function updateStyleArticles(i, raw) {
    writingStylesCache[i].articles = raw.split('{{----------}}').map(s => s.trim()).filter(Boolean);
}

async function importPresetStyle(presetId) {
    const res = await fetch(API + '/writing_style_preset/' + presetId);
    if (!res.ok) { showToast('é¢„è®¾åŠ è½½å¤±è´¥ âŒ'); return; }
    const preset = await res.json();
    // Check if already exists
    const existing = writingStylesCache.findIndex(s => s.id === preset.id);
    if (existing >= 0) {
        if (!confirm('å·²å­˜åœ¨åŒåé£æ ¼ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ')) return;
        writingStylesCache[existing] = preset;
    } else {
        writingStylesCache.push(preset);
    }
    await saveWritingStyles();
    renderStylesList();
    showToast('å·²å¯¼å…¥ã€Œ' + preset.name + 'ã€âœ…');
}

// ==================== Accounts ====================

function _platformLabel(p) {
    return { wechat_mp: 'å…¬ä¼—å·', xhs: 'å°çº¢ä¹¦' }[p] || p;
}

function _accountRow(acc, idx) {
    const cred = acc.credentials || {};
    const isWechat = acc.platform === 'wechat_mp';
    return `
    <div class="card" style="background:#0f172a; border:1px solid #334155; margin-bottom:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:700;">${acc.name || ('è´¦å·'+(idx+1))} <span style="font-size:12px; color:#64748b;">(${_platformLabel(acc.platform)})</span></div>
        <button class="btn btn-danger btn-sm" onclick="removeAccount('${acc.id}')">åˆ é™¤</button>
      </div>
      <div class="row" style="margin-top:12px;">
        <div style="flex:1;">
          <div class="form-group">
            <label>IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰</label>
            <input value="${acc.id||''}" oninput="accountsCache[${idx}].id=this.value">
            <div class="hint">è‡ªå®šä¹‰è‹±æ–‡æ ‡è¯†ï¼Œå¦‚ mp_techã€xhs_lifeã€‚ç”¨äºå†…éƒ¨å¼•ç”¨å’Œæ–‡ä»¶ç›®å½•å‘½åã€‚</div>
          </div>
          <div class="form-group"><label>åç§°</label><input value="${acc.name||''}" oninput="accountsCache[${idx}].name=this.value"></div>
          <div class="form-group">
            <label>å¹³å°</label>
            <select onchange="accountsCache[${idx}].platform=this.value; document.getElementById('accounts-list').innerHTML=accountsCache.map((a,i)=>_accountRow(a,i)).join('');">
              <option value="wechat_mp" ${acc.platform==='wechat_mp'?'selected':''}>å¾®ä¿¡å…¬ä¼—å·</option>
              <option value="xhs" ${acc.platform==='xhs'?'selected':''}>å°çº¢ä¹¦</option>
            </select>
          </div>
          <div class="form-group">
            <label>å¯ç”¨</label>
            <select onchange="accountsCache[${idx}].enabled=(this.value==='true')">
              <option value="true" ${acc.enabled!==false?'selected':''}>å¯ç”¨</option>
              <option value="false" ${acc.enabled===false?'selected':''}>ç¦ç”¨</option>
            </select>
          </div>
        </div>
        <div style="flex:1;">
          ${isWechat ? `
            <div class="form-group">
              <label>å…¬ä¼—å· AppID</label>
              <input value="${cred.appid||''}" oninput="accountsCache[${idx}].credentials=accountsCache[${idx}].credentials||{};accountsCache[${idx}].credentials.appid=this.value">
              <div class="hint">ç™»å½• <a href="https://mp.weixin.qq.com" target="_blank" style="color:#60a5fa;">å¾®ä¿¡å…¬ä¼—å¹³å°</a> â†’ è®¾ç½®ä¸å¼€å‘ â†’ åŸºæœ¬é…ç½® â†’ å¼€å‘è€…ID(AppID)</div>
            </div>
            <div class="form-group">
              <label>å…¬ä¼—å· AppSecret</label>
              <input type="password" value="${cred.secret||''}" oninput="accountsCache[${idx}].credentials=accountsCache[${idx}].credentials||{};accountsCache[${idx}].credentials.secret=this.value">
              <div class="hint">åŒä¸Šé¡µé¢ï¼Œç‚¹å‡»"é‡ç½®"è·å– Secretï¼ˆè¯·å¦¥å–„ä¿ç®¡ï¼‰ã€‚éœ€å°†æœåŠ¡å™¨IPåŠ å…¥ç™½åå•ã€‚</div>
            </div>
          ` : `
            <div style="padding:20px; color:#64748b; font-size:13px;">
              å°çº¢ä¹¦æš‚ä¸éœ€è¦å‡­è¯é…ç½®ï¼ˆå¾…æ¥å…¥å‘å¸ƒAPIåæ·»åŠ ï¼‰ã€‚
            </div>
          `}
        </div>
      </div>
    </div>`;
}

async function loadAccounts(forProfile=false) {
    const res = await fetch(API + '/accounts');
    const data = await res.json();
    accountsCache = data.accounts || [];
    const box = document.getElementById('accounts-list');
    if (box) box.innerHTML = accountsCache.map((a,i)=>_accountRow(a,i)).join('') || '<div style="color:#94a3b8;">æš‚æ— è´¦å·ï¼Œç‚¹å‡»"+ æ–°å¢è´¦å·"æ·»åŠ </div>';
    const opts = accountsCache.map(a=>`<option value="${a.id}">${a.name} (${_platformLabel(a.platform)})</option>`).join('');
    ['job_account', 'profile_account'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '<option value="">(é€‰æ‹©è´¦å·)</option>' + opts;
    });

    // Always default-select first account for Profiles if empty
    const profSel = document.getElementById('profile_account');
    if (profSel && !profSel.value && accountsCache.length > 0) {
        profSel.value = accountsCache[0].id;
    }

    if (forProfile) {
        // Ensure themes are ready for platform-specific dropdown
        await getWechatThemes();
        // Default select the first account when entering Profiles
        const sel = document.getElementById('profile_account');
        if (sel && !sel.value && accountsCache.length > 0) sel.value = accountsCache[0].id;
        await loadWriters();
        renderProfileEditor();
    }

    // Keep Jobs theme grid in sync with account platform
    await renderJobThemeGrid();
}

function addAccount() {
    const id = 'acc_' + Math.random().toString(36).slice(2,8);
    accountsCache.push({id, platform:'wechat_mp', name:'æ–°è´¦å·', enabled:true, credentials:{}, profile:{}});
    document.getElementById('accounts-list').innerHTML = accountsCache.map((a,i)=>_accountRow(a,i)).join('');
}
function removeAccount(id) {
    accountsCache = accountsCache.filter(a=>a.id!==id);
    document.getElementById('accounts-list').innerHTML = accountsCache.map((a,i)=>_accountRow(a,i)).join('');
}
async function saveAccounts() {
    const res = await fetch(API + '/accounts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({accounts: accountsCache}) });
    const data = await res.json();
    showToast(data.success ? 'å·²ä¿å­˜ âœ…' : 'å¤±è´¥ï¼š'+(data.error||''));
    await loadAccounts();
}

// ==================== Profiles ====================
let writersCache = {};

async function loadWriters() {
    const res = await fetch(API + '/writers');
    writersCache = await res.json();
}
function renderProfileEditor() {
    let id = document.getElementById('profile_account')?.value;
    if (!id && accountsCache.length > 0) {
        // recover: auto-select first account
        const sel = document.getElementById('profile_account');
        if (sel) { sel.value = accountsCache[0].id; id = sel.value; }
    }
    const acc = accountsCache.find(a=>a.id===id);
    const box = document.getElementById('profile-editor');
    if (!box) return;
    if (!acc) { box.innerHTML = '<div style="color:#94a3b8;">è¯·é€‰æ‹©è´¦å·</div>'; updateDebugPrompts(null); return; }
    acc.profile = acc.profile || {};
    const p = acc.profile;
    const img = p.image || (p.image={});
    const style = p.writing_style || (p.writing_style={});
    const content = p.content || (p.content={});

    let themeOpts = '';
    for (const [k, v] of Object.entries(window._allThemes || {})) {
        const sel = (p.layout_style_id || 'snow-cold') === k ? 'selected' : '';
        const layout = v.layout || 'card';
        themeOpts += `<option value="${k}" ${sel}>${v.name} (${LAYOUT_LABELS[layout]||layout})</option>`;
    }

    const _s = (field, fallback) => style[field] || fallback || '';
    const _kw = () => { const v = style.keywords; return Array.isArray(v) ? v.join(',') : (v||''); };

    box.innerHTML = `
      <div style="background:#0f172a; padding:20px; border-radius:12px; margin-bottom:16px;">
        <h4 style="color:#a78bfa; font-size:14px; margin-bottom:14px;">âœï¸ å†™ä½œé£æ ¼é…ç½®</h4>

        <div class="form-group">
          <label>è´¦å·é¢†åŸŸ</label>
          <input value="${_s('domain')}" oninput="_setStyle('${id}','domain',this.value)" placeholder="å¦‚ï¼šç§‘æŠ€æ•°ç ã€ç¾å¦†æŠ¤è‚¤ã€èŒåœºæˆé•¿ã€æƒ…æ„Ÿç”Ÿæ´»">
          <div class="hint">è´¦å·çš„å†…å®¹é¢†åŸŸå®šä½ï¼Œå†³å®šé€‰é¢˜æ–¹å‘å’Œä¸“ä¸šæœ¯è¯­</div>
        </div>

        <div class="form-group">
          <label>è´¦å·äººè®¾</label>
          <textarea rows="2" oninput="_setStyle('${id}','persona',this.value)" placeholder="å¦‚ï¼šæ•°ç çˆ±å¥½è€…ï¼Œå–œæ¬¢åˆ†äº«ç§‘æŠ€æ–°å“å’Œä½¿ç”¨å¿ƒå¾—">${_s('persona')}</textarea>
          <div class="hint">ä½ æƒ³å±•ç°çš„è§’è‰²å½¢è±¡ï¼Œå½±å“å†™ä½œè§†è§’å’Œå£å»</div>
        </div>

        <div class="form-group">
          <label>ç›®æ ‡å—ä¼—</label>
          <input value="${_s('audience')}" oninput="_setStyle('${id}','audience',this.value)" placeholder="å¦‚ï¼š18-35å²ï¼Œå…³æ³¨ç§‘æŠ€è¶‹åŠ¿çš„å¹´è½»äºº">
          <div class="hint">å†…å®¹é¢å‘çš„è¯»è€…ç”»åƒï¼Œå½±å“ç”¨è¯æ·±åº¦å’Œè¯é¢˜é€‰æ‹©</div>
        </div>

        <div class="form-group">
          <label>è¯­æ°”é£æ ¼</label>
          <input value="${_s('tone')}" oninput="_setStyle('${id}','tone',this.value)" placeholder="å¦‚ï¼šçœŸè¯šåˆ†äº« / çŠ€åˆ©ç‚¹è¯„ / è½»æ¾å¹½é»˜ / ä¸“ä¸šæµ‹è¯„ / å¹²è´§æ•™ç¨‹">
          <div class="hint">æ•´ä½“æ–‡å­—è°ƒæ€§ï¼Œå½±å“æªè¾å’Œè¡¨è¾¾æ–¹å¼</div>
        </div>

        <div class="form-group">
          <label>å†…å®¹è°ƒæ€§å…³é”®è¯</label>
          <input value="${_kw()}" oninput="_setStyle('${id}','keywords',this.value.split(',').map(s=>s.trim()).filter(Boolean))" placeholder="çœŸå®ä½“éªŒ,å®ç”¨æ¨è,ç§‘æŠ€ç”Ÿæ´»ï¼ˆé€—å·åˆ†éš”ï¼‰">
          <div class="hint">3-5ä¸ªå…³é”®è¯ï¼Œæ¦‚æ‹¬å†…å®¹è°ƒæ€§</div>
        </div>

        <div class="form-group">
          <label>æ¨¡ä»¿é£æ ¼</label>
          <select onchange="_setStyle('${id}','reference',this.value); updateDebugPrompts(accountsCache.find(a=>a.id==='${id}'))">
            <option value="">ä¸æ¨¡ä»¿ï¼ˆä½¿ç”¨é»˜è®¤é£æ ¼ï¼‰</option>
            ${(writingStylesCache||[]).map(ws => `<option value="${ws.id}" ${style.reference===ws.id?'selected':''}>${ws.name}ï¼ˆ${ws.articles?.length||0}ç¯‡å‚è€ƒï¼‰</option>`).join('')}
          </select>
          <div class="hint">åœ¨ Settings é¡µé¢ç®¡ç†é£æ ¼æ¨¡æ¿ï¼Œæ·»åŠ å‚è€ƒæ–‡ç« </div>
        </div>

        <div class="form-group">
          <label>é¢å¤–å†™ä½œè¦æ±‚</label>
          <textarea rows="2" oninput="_setStyle('${id}','extra_instructions',this.value)" placeholder="å¦‚ï¼šæ¯ç¯‡å¿…é¡»åŒ…å«3ä¸ªä»¥ä¸Šå…·ä½“æ¡ˆä¾‹ã€ç»“å°¾è¦æœ‰è¡ŒåŠ¨å»ºè®®">${_s('extra_instructions')}</textarea>
          <div class="hint">ä»»ä½•é¢å¤–çš„å†™ä½œè§„åˆ™æˆ–åå¥½ï¼Œä¼šé™„åŠ åˆ° prompt æœ«å°¾</div>
        </div>
      </div>

      <div style="background:#0f172a; padding:20px; border-radius:12px; margin-top:12px;">
        <h4 style="color:#f472b6; font-size:14px; margin-bottom:12px;">ğŸ·ï¸ æ ‡é¢˜ç”Ÿæˆé…ç½®</h4>
        <p style="color:#64748b; font-size:12px; margin-bottom:12px;">æ§åˆ¶æ–‡ç« æ ‡é¢˜çš„é£æ ¼å’Œçƒ­ç‚¹èåˆæ–¹å¼ã€‚ç”Ÿæˆæ–‡ç« æ—¶ä¼šè‡ªåŠ¨è¯»å–è¿™é‡Œçš„é…ç½®ã€‚</p>
        <div class="form-group">
          <label>æ ‡é¢˜é£æ ¼æè¿°</label>
          <textarea rows="3" oninput="_setTitle('${id}','style_desc',this.value); updateDebugPrompts(accountsCache.find(a=>a.id==='${id}'))"
            placeholder="å¦‚ï¼šç¦…æ„å…‹åˆ¶ï¼Œç‚¹åˆ°å³æ­¢ï¼Œä¸åšæ ‡é¢˜å…šï¼Œå¤šç”¨æ„è±¡å’Œéšå–»&#10;æˆ–ï¼šçŠ€åˆ©è§‚ç‚¹å‹ï¼Œä¸€é’ˆè§è¡€ï¼Œç›´å‡»ç—›ç‚¹&#10;æˆ–ï¼šæ‚¬å¿µå‹ï¼Œå¼•å‘å¥½å¥‡å¿ƒï¼Œè®©äººæƒ³ç‚¹è¿›æ¥çœ‹"
          >${(acc.profile?.title_config?.style_desc)||''}</textarea>
          <div class="hint">æè¿°ä½ æƒ³è¦çš„æ ‡é¢˜é£æ ¼ï¼ŒAI ä¼šæ®æ­¤ç”Ÿæˆæ ‡é¢˜</div>
        </div>
        <div class="form-group">
          <label>çƒ­ç‚¹ä¸è‡ªèº«å†…å®¹é…æ¯”</label>
          <select onchange="_setTitle('${id}','hotspot_ratio',this.value); updateDebugPrompts(accountsCache.find(a=>a.id==='${id}'))">
            <option value="hot_dominant" ${(acc.profile?.title_config?.hotspot_ratio)==='hot_dominant'?'selected':''}>çƒ­ç‚¹ä¸»å¯¼ï¼ˆ70%çƒ­ç‚¹ + 30%è´¦å·è§†è§’ï¼‰</option>
            <option value="balanced" ${(acc.profile?.title_config?.hotspot_ratio||'balanced')==='balanced'?'selected':''}>å‡è¡¡èåˆï¼ˆ50%çƒ­ç‚¹ + 50%è´¦å·è§†è§’ï¼‰</option>
            <option value="self_dominant" ${(acc.profile?.title_config?.hotspot_ratio)==='self_dominant'?'selected':''}>è´¦å·ä¸»å¯¼ï¼ˆ30%çƒ­ç‚¹ + 70%è´¦å·è§†è§’ï¼‰</option>
            <option value="self_only" ${(acc.profile?.title_config?.hotspot_ratio)==='self_only'?'selected':''}>çº¯è´¦å·è§†è§’ï¼ˆçƒ­ç‚¹ä»…ä½œçµæ„Ÿï¼Œæ ‡é¢˜ä¸ä½“ç°çƒ­ç‚¹ï¼‰</option>
          </select>
          <div class="hint">å†³å®šæ ‡é¢˜ä¸­çƒ­ç‚¹äº‹ä»¶å’Œè´¦å·è‡ªèº«å®šä½çš„æƒé‡åˆ†é…</div>
        </div>
        <div class="row" style="gap:12px;">
          <div class="col-4">
            <div class="form-group">
              <label>æ ‡é¢˜æœ€çŸ­å­—æ•°ï¼ˆå¯é€‰ï¼‰</label>
              <input type="number" value="${(acc.profile?.title_config?.len_min??'')}" min="6" max="60" placeholder="ä¾‹å¦‚ 12" oninput="_setTitle('${id}','len_min', this.value===''?null:parseInt(this.value)); updateDebugPrompts(accountsCache.find(a=>a.id==='${id}'))">
            </div>
          </div>
          <div class="col-4">
            <div class="form-group">
              <label>æ ‡é¢˜æœ€é•¿å­—æ•°ï¼ˆå¯é€‰ï¼‰</label>
              <input type="number" value="${(acc.profile?.title_config?.len_max??'')}" min="8" max="80" placeholder="ä¾‹å¦‚ 28" oninput="_setTitle('${id}','len_max', this.value===''?null:parseInt(this.value)); updateDebugPrompts(accountsCache.find(a=>a.id==='${id}'))">
            </div>
          </div>
          <div class="col-4">
            <div class="form-group">
              <label>æ ‡é¢˜é¢å¤–è¦æ±‚</label>
              <input value="${(acc.profile?.title_config?.extra)||''}" oninput="_setTitle('${id}','extra',this.value); updateDebugPrompts(accountsCache.find(a=>a.id==='${id}'))"
                placeholder="å¦‚ï¼šä¸è¶…è¿‡20å­— / å¿…é¡»åŒ…å«æ•°å­— / é¿å…é—®å¥">
            </div>
          </div>
        </div>
        <div class="hint">å»ºè®®è®¾ç½®â€œæœ€é•¿å­—æ•°â€ï¼Œé˜²æ­¢æ ‡é¢˜è¿‡é•¿ï¼›ä¸å¡«åˆ™è‡ªåŠ¨ã€‚</div>
      </div>

      <div class="form-group">
        <label>æ’ç‰ˆä¸»é¢˜</label>
        <select onchange="accountsCache.find(a=>a.id==='${id}').profile.layout_style_id=this.value; updateDebugPrompts(accountsCache.find(a=>a.id==='${id}'))">${themeOpts}</select>
      </div>

      <div style="background:#0f172a; padding:20px; border-radius:12px; margin-top:12px;">
        <h4 style="color:#34d399; font-size:14px; margin-bottom:12px;">ğŸ“ å†…å®¹é•¿åº¦å»ºè®®ï¼ˆé€‰å¡«ï¼‰</h4>
        <div class="row">
          <div class="col-4">
            <div class="form-group">
              <label>å»ºè®®æ®µè½æ•°</label>
              <input type="number" value="${content.section_count??''}" min="1" max="20" placeholder="ä¾‹å¦‚ 6" oninput="_setContent('${id}','section_count', this.value===''?null:parseInt(this.value))">
              <div class="hint">å¸Œæœ›æ–‡ç« å¤§æ¦‚åˆ†æˆå¤šå°‘æ®µ/å°èŠ‚ï¼ˆä¸å¡«åˆ™è‡ªåŠ¨ï¼‰</div>
            </div>
          </div>
          <div class="col-4">
            <div class="form-group">
              <label>å»ºè®®æœ€å°‘å­—æ•°</label>
              <input type="number" value="${content.word_count_min??''}" min="200" max="10000" placeholder="ä¾‹å¦‚ 900" oninput="_setContent('${id}','word_count_min', this.value===''?null:parseInt(this.value))">
            </div>
          </div>
          <div class="col-4">
            <div class="form-group">
              <label>å»ºè®®æœ€å¤šå­—æ•°</label>
              <input type="number" value="${content.word_count_max??''}" min="200" max="20000" placeholder="ä¾‹å¦‚ 1400" oninput="_setContent('${id}','word_count_max', this.value===''?null:parseInt(this.value))">
            </div>
          </div>
        </div>
        <div class="hint">ç”¨äºè®©ç”Ÿæˆç»“æœæ›´ç¨³å®šï¼šæ¯”å¦‚â€œ900-1400å­—ã€6æ®µå·¦å³â€ã€‚</div>
      </div>

      <div style="background:#0f172a; padding:20px; border-radius:12px; margin-top:12px;">
        <h4 style="color:#60a5fa; font-size:14px; margin-bottom:12px;">ğŸ“· å›¾ç‰‡ç”Ÿæˆé…ç½®</h4>
        <p style="color:#64748b; font-size:12px; margin-bottom:12px;"><strong style="color:#94a3b8;">åŸºäºæ–‡ç« è¯­ä¹‰ + è§†è§‰å¸å¼•åŠ›</strong>æ˜¯å†…ç½®åŸºç¡€è¦æ±‚ï¼Œè¿™é‡Œåªå¡«é¢å¤–é£æ ¼åå¥½ã€‚</p>

        <div class="form-group">
          <label>å°é¢å›¾é£æ ¼è¦æ±‚</label>
          <textarea rows="2" oninput="_setImg('${id}','cover_prompt',this.value); updateDebugPrompts(accountsCache.find(a=>a.id==='${id}'))" placeholder="å¦‚ï¼šç§‘æŠ€æ„Ÿã€æš—è‰²è°ƒ / é»‘ç™½æœ¨åˆ»ç‰ˆç”»é£ / ç®€æ´æ‰å¹³æ’ç”»">${img.cover_prompt||''}</textarea>
          <div class="hint">å°é¢å›¾çš„è§†è§‰é£æ ¼ã€‚è¯­ä¹‰å†…å®¹ç”±æ–‡ç« æ ‡é¢˜è‡ªåŠ¨æä¾›ã€‚</div>
        </div>
        <div class="form-group">
          <label>æ–‡ä¸­æ’å›¾æ•°é‡</label>
          <input type="number" value="${img.inline_count??2}" min="0" max="9" oninput="_setImg('${id}','inline_count',parseInt(this.value||'0'))">
        </div>
        <div class="form-group">
          <label>æ’å›¾é£æ ¼è¦æ±‚</label>
          <textarea rows="2" oninput="_setImg('${id}','inline_prompt',this.value); updateDebugPrompts(accountsCache.find(a=>a.id==='${id}'))" placeholder="å¦‚ï¼šæ‰å¹³æ’ç”»é£ã€æ¸…æ–°æ°´å½©ã€å†™å®æ‘„å½±ã€ä¸å°é¢ç»Ÿä¸€é£æ ¼">${img.inline_prompt||''}</textarea>
          <div class="hint">æ¯å¼ æ’å›¾ä¼šè‡ªåŠ¨å…³è”å¯¹åº”æ®µè½çš„è¯­ä¹‰å†…å®¹ã€‚</div>
        </div>
      </div>
    `;
    updateDebugPrompts(acc);
}

function _setStyle(accId, field, value) {
    const acc = accountsCache.find(a=>a.id===accId);
    if (!acc) return;
    acc.profile = acc.profile || {};
    acc.profile.writing_style = acc.profile.writing_style || {};
    acc.profile.writing_style[field] = value;
    updateDebugPrompts(acc);
}
function _setImg(accId, field, value) {
    const acc = accountsCache.find(a=>a.id===accId);
    if (!acc) return;
    acc.profile = acc.profile || {};
    acc.profile.image = acc.profile.image || {};
    acc.profile.image[field] = value;
}

function _setContent(accId, field, value) {
    const acc = accountsCache.find(a=>a.id===accId);
    if (!acc) return;
    acc.profile = acc.profile || {};
    acc.profile.content = acc.profile.content || {};
    acc.profile.content[field] = value;
    updateDebugPrompts(acc);
}

function _setTitle(accId, field, value) {
    const acc = accountsCache.find(a=>a.id===accId);
    if (!acc) return;
    acc.profile = acc.profile || {};
    acc.profile.title_config = acc.profile.title_config || {};
    acc.profile.title_config[field] = value;
}

function updateDebugPrompts(acc) {
    const box = document.getElementById('debug-prompts');
    if (!box) return;

    // If caller didn't pass account (or stale ref), try to resolve from current selector
    if (!acc) {
        const id = document.getElementById('profile_account')?.value;
        if (id) acc = accountsCache.find(a=>a.id===id);
    }

    if (!acc) {
        const id = document.getElementById('profile_account')?.value || '';
        box.innerHTML = `<div style="color:#64748b;">é€‰æ‹©è´¦å·åæ˜¾ç¤ºï¼ˆå½“å‰é€‰æ‹©ï¼š${id||'ç©º'}ï¼Œè´¦å·æ•°ï¼š${accountsCache?.length||0}ï¼‰</div>`;
        return;
    }
    const p = acc.profile || {};
    const s = p.writing_style || {};
    const img = p.image || {};
    const platform = acc.platform === 'wechat_mp' ? 'å…¬ä¼—å·' : 'å°çº¢ä¹¦';
    const ph = (label) => `<span style="color:#f59e0b">{${label}}</span>`;

    const domain = s.domain || ph('æœªå¡«å†™ï¼šè´¦å·é¢†åŸŸ');
    const persona = s.persona || ph('æœªå¡«å†™ï¼šè´¦å·äººè®¾');
    const audience = s.audience || ph('æœªå¡«å†™ï¼šç›®æ ‡å—ä¼—');
    const tone = s.tone || ph('æœªå¡«å†™ï¼šè¯­æ°”é£æ ¼');
    const keywords = (Array.isArray(s.keywords) ? s.keywords.join('ã€') : s.keywords) || ph('æœªå¡«å†™ï¼šè°ƒæ€§å…³é”®è¯');
    const _refStyle = s.reference ? (writingStylesCache||[]).find(ws=>ws.id===s.reference) : null;
    const reference = _refStyle ? `${_refStyle.name}ï¼ˆ${_refStyle.articles?.length||0}ç¯‡å‚è€ƒæ–‡ç« ï¼‰` : 'ï¼ˆæ— ï¼Œä½¿ç”¨å¹³å°é»˜è®¤é£æ ¼ï¼‰';
    const extraInst = s.extra_instructions || 'ï¼ˆæ— ï¼‰';
    const coverStyle = img.cover_prompt || 'ï¼ˆæ— é¢å¤–è¦æ±‚ï¼‰';
    const inlineStyle = img.inline_prompt || 'ï¼ˆæ— é¢å¤–è¦æ±‚ï¼‰';

    const c = p.content || {};
    const secCount = (c.section_count!=null && c.section_count!=='') ? c.section_count : 'ï¼ˆæœªè®¾ç½®ï¼‰';
    const wcMin = (c.word_count_min!=null && c.word_count_min!=='') ? c.word_count_min : 'ï¼ˆæœªè®¾ç½®ï¼‰';
    const wcMax = (c.word_count_max!=null && c.word_count_max!=='') ? c.word_count_max : 'ï¼ˆæœªè®¾ç½®ï¼‰';

    const tc = p.title_config || {};
    const titleStyleDesc = tc.style_desc || ph('æœªé…ç½®ï¼šæ ‡é¢˜é£æ ¼æè¿°');
    const _hrMap = { hot_dominant:'çƒ­ç‚¹ä¸»å¯¼ï¼ˆ70%çƒ­ç‚¹+30%è´¦å·è§†è§’ï¼‰', balanced:'å‡è¡¡èåˆï¼ˆ50%+50%ï¼‰', self_dominant:'è´¦å·ä¸»å¯¼ï¼ˆ30%çƒ­ç‚¹+70%è´¦å·è§†è§’ï¼‰', self_only:'çº¯è´¦å·è§†è§’ï¼ˆçƒ­ç‚¹ä»…ä½œçµæ„Ÿï¼‰' };
    const hotRatio = _hrMap[tc.hotspot_ratio||'balanced'] || 'å‡è¡¡èåˆ';
    const titleLenMin = (tc.len_min!=null && tc.len_min!=='') ? tc.len_min : 'ï¼ˆæœªè®¾ç½®ï¼‰';
    const titleLenMax = (tc.len_max!=null && tc.len_max!=='') ? tc.len_max : 'ï¼ˆæœªè®¾ç½®ï¼‰';
    const titleExtra = tc.extra || 'ï¼ˆæ— ï¼‰';

    const _withLineNumbers = (txt) => {
      const lines = String(txt||'').split('\n');
      return lines.map((l,i)=>`${String(i+1).padStart(4,' ')} | ${l}`).join('\n');
    };
    const _pre = (title, color, content) => `
      <div style="margin-bottom:16px;">
        <div style="color:${color}; font-weight:600; font-size:13px; margin-bottom:6px;">${title}</div>
        <pre style="background:#0f172a; padding:14px; border-radius:8px; font-size:12px; line-height:1.7; white-space:pre; overflow:auto; color:#cbd5e1; border:1px solid #334155; max-height:520px;">${_withLineNumbers(content)}</pre>
      </div>`;

    const articlePrompt = `ä½ æ˜¯ä¸€ä½${platform}å†…å®¹åˆ›ä½œè€…ã€‚

## è´¦å·å®šä½
- é¢†åŸŸï¼š${domain}
- äººè®¾ï¼š${persona}
- å—ä¼—ï¼š${audience}
- è¯­æ°”ï¼š${tone}
- è°ƒæ€§å…³é”®è¯ï¼š${keywords}
- é£æ ¼å‚è€ƒï¼š${reference}
- æ®µè½å»ºè®®ï¼š${secCount}
- å­—æ•°å»ºè®®ï¼š${wcMin} ~ ${wcMax}

## é¢å¤–è¦æ±‚
${extraInst}

## ä»»åŠ¡
è¯·æ ¹æ®ä»¥ä¸‹çƒ­ç‚¹/ä¸»é¢˜ï¼Œåˆ›ä½œä¸€ç¯‡é«˜è´¨é‡${platform}æ–‡ç« ã€‚

ä¸»é¢˜/å…³é”®è¯ï¼š${ph('è¿è¡Œæ—¶ä¼ å…¥ï¼šç”¨æˆ·è¾“å…¥çš„å…³é”®è¯æˆ–çƒ­ç‚¹æ ‡é¢˜')}
æœç´¢è¡¥å……èµ„æ–™ï¼š${ph('è¿è¡Œæ—¶ä¼ å…¥ï¼šæœç´¢å¼•æ“è¿”å›çš„èƒŒæ™¯ä¿¡æ¯')}

è¦æ±‚ï¼š
1. æ ‡é¢˜è¦æœ‰å¸å¼•åŠ›å’Œç‚¹å‡»æ¬²
2. å†…å®¹æœ‰æ·±åº¦ã€æœ‰è§‚ç‚¹ã€æœ‰ä»·å€¼
3. ç»“æ„æ¸…æ™°ï¼Œæ®µè½åˆ†æ˜
4. ç¬¦åˆ${platform}å¹³å°çš„å†…å®¹è§„èŒƒå’Œç”¨æˆ·é˜…è¯»ä¹ æƒ¯

ç›´æ¥è¾“å‡ºæ ‡é¢˜å’Œæ­£æ–‡ã€‚`;

    const coverPromptText = `è¯·ä¸ºä»¥ä¸‹æ–‡ç« ç”Ÿæˆå°é¢å›¾ã€‚

æ–‡ç« æ ‡é¢˜ï¼š${ph('è¿è¡Œæ—¶ä¼ å…¥ï¼šAIç”Ÿæˆçš„æ–‡ç« æ ‡é¢˜')}
æ–‡ç« æ‘˜è¦ï¼š${ph('è¿è¡Œæ—¶ä¼ å…¥ï¼šæ–‡ç« æ ¸å¿ƒè§‚ç‚¹æ¦‚è¦')}

åŸºç¡€è¦æ±‚ï¼ˆå·²å†…ç½®ï¼‰ï¼š
- åŸºäºæ–‡ç« è¯­ä¹‰ï¼Œè§†è§‰å¸å¼•åŠ›å¼º
- é€‚åˆ${platform}ä¿¡æ¯æµå±•ç¤º
- ${acc.platform === 'xhs' ? '3:4ç«–ç‰ˆæ¯”ä¾‹' : '16:9æ¨ªç‰ˆæ¯”ä¾‹'}

é¢å¤–é£æ ¼è¦æ±‚ï¼š${coverStyle}`;

    const inlinePromptText = `è¯·ä¸ºæ–‡ç« çš„ç¬¬ ${ph('N')} æ®µç”Ÿæˆé…å›¾ã€‚

æ‰€åœ¨æ®µè½æ ‡é¢˜ï¼š${ph('è¿è¡Œæ—¶ä¼ å…¥ï¼šè¯¥æ®µè½çš„å°æ ‡é¢˜')}
æ®µè½æ ¸å¿ƒå†…å®¹ï¼š${ph('è¿è¡Œæ—¶ä¼ å…¥ï¼šè¯¥æ®µè½çš„è¯­ä¹‰æ‘˜è¦ï¼Œç”±AIæ ¹æ®ä¸Šä¸‹æ–‡æç‚¼')}
æ–‡ç« æ•´ä½“ä¸»é¢˜ï¼š${ph('è¿è¡Œæ—¶ä¼ å…¥ï¼šæ–‡ç« æ ‡é¢˜')}

åŸºç¡€è¦æ±‚ï¼ˆå·²å†…ç½®ï¼‰ï¼š
- ä¸æ®µè½å†…å®¹è¯­ä¹‰å¼ºç›¸å…³
- è§†è§‰å¸å¼•åŠ›å¼ºï¼Œæ„å›¾ç¾è§‚
- åˆ†è¾¨ç‡ 1024Ã—1024

é¢å¤–é£æ ¼è¦æ±‚ï¼š${inlineStyle}`;

    const titlePrompt = `ä¸ºä»¥ä¸‹çƒ­ç‚¹ä¸»é¢˜ç”Ÿæˆæ–‡ç« æ ‡é¢˜ã€‚

çƒ­ç‚¹ä¸»é¢˜ï¼š${ph('è¿è¡Œæ—¶ä¼ å…¥ï¼šçƒ­ç‚¹æ ‡é¢˜æˆ–å…³é”®è¯')}
çƒ­ç‚¹æ¥æºï¼š${ph('è¿è¡Œæ—¶ä¼ å…¥ï¼šç™¾åº¦çƒ­æœ/å¾®åš ç­‰')}

## è´¦å·å®šä½
- é¢†åŸŸï¼š${domain}
- äººè®¾ï¼š${persona}
- å—ä¼—ï¼š${audience}

## æ ‡é¢˜é£æ ¼è¦æ±‚
${titleStyleDesc}

## çƒ­ç‚¹èåˆç­–ç•¥
${hotRatio}

## æ ‡é¢˜é•¿åº¦ï¼ˆå­—æ•°å»ºè®®ï¼‰
- æœ€çŸ­ï¼š${titleLenMin}
- æœ€é•¿ï¼š${titleLenMax}

## é¢å¤–çº¦æŸ
${titleExtra}

è¯·ç”Ÿæˆ 3 ä¸ªå€™é€‰æ ‡é¢˜ï¼Œæ¯ä¸ªæ ‡é¢˜æ¢è¡Œè¾“å‡ºã€‚`;

    box.innerHTML =
        _pre('ğŸ·ï¸ æ ‡é¢˜ç”Ÿæˆ Prompt', '#f472b6', titlePrompt) +
        _pre('ğŸ“ æ–‡ç« ç”Ÿæˆ Prompt', '#a78bfa', articlePrompt) +
        _pre('ğŸ–¼ï¸ å°é¢å›¾ Prompt', '#60a5fa', coverPromptText) +
        _pre('ğŸ¨ æ–‡ä¸­æ’å›¾ Promptï¼ˆæ¯å¼ æ’å›¾å„ç”Ÿæˆä¸€æ¬¡ï¼‰', '#4ade80', inlinePromptText);
}

async function saveProfile() { await saveAccounts(); }
async function saveProfile() { await saveAccounts(); }

// ==================== Autotopic Run Once ====================
async function runAutotopicOnce(){
  showToast('æ­£åœ¨æ‰§è¡Œé€‰é¢˜...');
  const res = await fetch(API + '/autotopic/run_once', {method:'POST'});
  const data = await res.json();
  if (data.success) {
    showToast(`é€‰é¢˜å®Œæˆ âœ… å…±${data.total_hot}æ¡çƒ­ç‚¹ï¼Œ${data.accounts_count}ä¸ªè´¦å·`);
    // Show result in a modal-like area below the button
    const preview = document.getElementById('autotopic-result');
    if (preview) {
      preview.innerHTML = `<pre style="background:#0f172a; padding:14px; border-radius:8px; font-size:13px; line-height:1.8; white-space:pre-wrap; color:#cbd5e1; border:1px solid #334155; margin-top:12px;">${data.message||''}</pre>
      <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
        <input id="at-selection" type="text" placeholder="è¾“å…¥é€‰æ‹©ï¼Œå¦‚ A1,A5" style="flex:1; padding:8px 12px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e2e8f0; font-size:14px;">
        <button class="btn btn-primary" onclick="runAutotopicGenerate()" style="white-space:nowrap;">ğŸš€ ç”Ÿæˆé€‰ä¸­æ–‡ç« </button>
      </div>
      <div id="at-gen-result" style="margin-top:8px;"></div>`;
    }
  } else {
    showToast('è§¦å‘å¤±è´¥ï¼š' + (data.error||''));
  }
}

// ==================== Autotopic Select & Generate ====================
async function runAutotopicGenerate() {
    const input = document.getElementById('at-selection');
    const resultBox = document.getElementById('at-gen-result');
    const text = (input?.value || '').trim();
    if (!text) { showToast('è¯·è¾“å…¥é€‰æ‹©ï¼Œå¦‚ A1,A5'); return; }

    // Step 1: Parse selection
    resultBox.innerHTML = '<div style="color:#60a5fa;">â³ è§£æé€‰æ‹©...</div>';
    const selRes = await fetch(API + '/autotopic/select', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({selection: text}),
    });
    const selData = await selRes.json();
    if (!selData.success) {
        resultBox.innerHTML = `<div style="color:#f87171;">âŒ ${selData.error}</div>`;
        return;
    }

    // Step 2: Generate articles (synchronous, may take a while)
    resultBox.innerHTML = `<div style="color:#60a5fa;">â³ æ­£åœ¨ç”Ÿæˆ ${selData.count} ç¯‡æ–‡ç« ï¼ˆAIå†™ä½œ + é…å›¾ï¼Œçº¦1-2åˆ†é’Ÿ/ç¯‡ï¼‰...</div>`;
    try {
        const genRes = await fetch(API + '/autotopic/generate', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({selections: selData.selections}),
        });
        const genData = await genRes.json();
        if (genData.success) {
            let html = '<div style="color:#4ade80; margin-bottom:8px;">âœ… ç”Ÿæˆå®Œæˆï¼</div>';
            for (const t of genData.tasks) {
                if (t.error) {
                    html += `<div style="color:#f87171;">âŒ ${t.keyword}: ${t.error}</div>`;
                } else {
                    html += `<div style="margin-bottom:6px;">ğŸ“„ <strong>${t.title||t.keyword}</strong> â€” <a href="${t.preview_url}" target="_blank" style="color:#60a5fa;">é¢„è§ˆ</a></div>`;
                }
            }
            resultBox.innerHTML = html;
        } else {
            resultBox.innerHTML = `<div style="color:#f87171;">âŒ ${genData.error||'ç”Ÿæˆå¤±è´¥'}</div>`;
        }
    } catch(e) {
        resultBox.innerHTML = `<div style="color:#f87171;">âŒ è¯·æ±‚å¤±è´¥: ${e.message}</div>`;
    }
}

// ==================== Layouts ====================
async function loadLayoutThemes() {
    // Separate wechat vs xhs layouts (do not mix)
    const platform = document.getElementById('layout-platform')?.value || 'wechat';

    if (platform === 'xhs') {
        const themes = await getXhsThemes();
        if (!layoutSelectedTheme || !(layoutSelectedTheme in themes)) {
            layoutSelectedTheme = Object.keys(themes||{})[0] || layoutSelectedTheme;
        }
        renderThemeGrid('layout-themes', themes, layoutSelectedTheme, k => {
            layoutSelectedTheme = k;
            loadLayoutThemes();
        });
        previewLayout();
        return;
    }

    const themes = await getWechatThemes();
    if (!layoutSelectedTheme || !(layoutSelectedTheme in themes)) {
        layoutSelectedTheme = 'snow-cold';
    }
    renderThemeGrid('layout-themes', themes, layoutSelectedTheme, k => {
        layoutSelectedTheme = k;
        loadLayoutThemes();
    });
    previewLayout();
}

const _layoutCache = {};
async function previewLayout() {
    const platform = document.getElementById('layout-platform')?.value || 'wechat';
    const box = document.getElementById('layout-preview');
    if (!box) return;
    const cacheKey = `${platform}:${layoutSelectedTheme}`;
    
    let html = _layoutCache[cacheKey];
    if (!html) {
        box.innerHTML = '<div style="padding:40px; text-align:center; color:#94a3b8;">åŠ è½½é¢„è§ˆä¸­...</div>';
        try {
            const res = await fetch(API + '/layout/preview', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ theme: layoutSelectedTheme, platform })
            });
            const data = await res.json();
            html = data.html;
            _layoutCache[cacheKey] = html;
        } catch(e) {
            box.innerHTML = `<div style="color:#f87171;">${e.message}</div>`;
            return;
        }
    }
    const iframe = document.createElement('iframe');
    iframe.style.cssText = 'width:100%; min-height:600px; border:none;';
    box.innerHTML = '';
    box.appendChild(iframe);
    try {
        iframe.contentDocument.open();
        iframe.contentDocument.write(html);
        iframe.contentDocument.close();
        setTimeout(() => {
            try { iframe.style.height = iframe.contentDocument.body.scrollHeight + 40 + 'px'; } catch(e) {}
        }, 300);
    } catch(e) {
        box.innerHTML = `<div style="padding:20px; color:#f87171;">é¢„è§ˆåŠ è½½å¤±è´¥: ${e.message}</div>`;
    }
}

// ==================== Autotopic ====================
const ALL_HOT_SOURCES = ['weibo', 'zhihu', 'baidu', 'toutiao', 'bilibili', 'douyin', 'thepaper', 'reddit'];
const ALL_PLATFORMS = ['wechat', 'xhs'];

async function loadAutotopic() {
    const res = await fetch(API + '/autotopic');
    const cfg = await res.json();
    document.getElementById('at_enabled').value = String(cfg.enabled || false);
    document.getElementById('at_mode').value = cfg.mode || 'auto';
    document.getElementById('at_auto_count').value = cfg.auto_count || 3;
    document.getElementById('at_hot_title_count').value = cfg.hot_title_count || 3;
    document.getElementById('at_self_title_count').value = cfg.self_title_count || 3;
    document.getElementById('at_schedule').value = cfg.schedule || '0 9 * * *';
    document.getElementById('at_timezone').value = cfg.timezone || 'Asia/Shanghai';
    document.getElementById('at_search_engine').value = cfg.search_engine || 'brave';
    document.getElementById('at_filter').value = (cfg.filter_keywords || []).join(',');
    document.getElementById('at_exclude').value = (cfg.exclude_keywords || []).join(',');

    const sources = cfg.hot_sources || [];
    document.getElementById('at_sources').innerHTML = ALL_HOT_SOURCES.map(s =>
        `<span class="chip ${sources.includes(s)?'chip-on':'chip-off'}" data-val="${s}" onclick="this.classList.toggle('chip-on');this.classList.toggle('chip-off');">${s}</span>`
    ).join('');

    const plats = cfg.target_platforms || [];
    document.getElementById('at_platforms').innerHTML = ALL_PLATFORMS.map(p =>
        `<span class="chip ${plats.includes(p)?'chip-on':'chip-off'}" data-val="${p}" onclick="this.classList.toggle('chip-on');this.classList.toggle('chip-off');">${{wechat:'å…¬ä¼—å·',xhs:'å°çº¢ä¹¦'}[p]||p}</span>`
    ).join('');
}

function _getChipValues(containerId) {
    return [...document.getElementById(containerId).querySelectorAll('.chip-on')].map(el => el.dataset.val);
}

async function saveAutotopic() {
    const cfg = {
        enabled: document.getElementById('at_enabled').value === 'true',
        mode: document.getElementById('at_mode').value,
        auto_count: parseInt(document.getElementById('at_auto_count').value),
        hot_title_count: parseInt(document.getElementById('at_hot_title_count').value),
        self_title_count: parseInt(document.getElementById('at_self_title_count').value),
        schedule: document.getElementById('at_schedule').value,
        timezone: document.getElementById('at_timezone').value,
        hot_sources: _getChipValues('at_sources'),
        search_engine: document.getElementById('at_search_engine').value,
        search_supplement: document.getElementById('at_search_engine').value !== 'none',
        filter_keywords: document.getElementById('at_filter').value.split(',').map(s=>s.trim()).filter(Boolean),
        exclude_keywords: document.getElementById('at_exclude').value.split(',').map(s=>s.trim()).filter(Boolean),
        target_platforms: _getChipValues('at_platforms'),
    };
    const res = await fetch(API + '/autotopic', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(cfg) });
    const data = await res.json();
    showToast(data.success ? 'è‡ªåŠ¨é€‰é¢˜é…ç½®å·²ä¿å­˜ âœ…' : 'ä¿å­˜å¤±è´¥');
}

// ==================== Autotopic Debug ====================
function updateAutotopicDebug() {
    const accId = document.getElementById('at_debug_account')?.value;
    const acc = accountsCache.find(a => a.id === accId);
    const box = document.getElementById('at-debug-prompts');
    if (!box) return;
    if (!acc) { box.innerHTML = '<div style="color:#64748b;">é€‰æ‹©è´¦å·åæ˜¾ç¤º</div>'; return; }

    const p = acc.profile || {};
    const s = p.writing_style || {};
    const img = p.image || {};
    const platform = acc.platform === 'wechat_mp' ? 'å…¬ä¼—å·' : 'å°çº¢ä¹¦';
    const ph = (label) => `<span style="color:#f59e0b">{${label}}</span>`;

    const domain = s.domain || ph('æœªé…ç½®ï¼šè´¦å·é¢†åŸŸ');
    const persona = s.persona || ph('æœªé…ç½®ï¼šè´¦å·äººè®¾');
    const audience = s.audience || ph('æœªé…ç½®ï¼šç›®æ ‡å—ä¼—');
    const tone = s.tone || ph('æœªé…ç½®ï¼šè¯­æ°”é£æ ¼');
    const keywords = (Array.isArray(s.keywords) ? s.keywords.join('ã€') : s.keywords) || ph('æœªé…ç½®ï¼šè°ƒæ€§å…³é”®è¯');
    const _refStyle = s.reference ? (writingStylesCache||[]).find(ws=>ws.id===s.reference) : null;
    const reference = _refStyle ? `${_refStyle.name}ï¼ˆ${_refStyle.articles?.length||0}ç¯‡å‚è€ƒæ–‡ç« ï¼‰` : 'ï¼ˆæ— ï¼Œä½¿ç”¨å¹³å°é»˜è®¤é£æ ¼ï¼‰';
    const extraInst = s.extra_instructions || 'ï¼ˆæ— ï¼‰';
    const coverStyle = img.cover_prompt || 'ï¼ˆæ— é¢å¤–è¦æ±‚ï¼‰';
    const inlineStyle = img.inline_prompt || 'ï¼ˆæ— é¢å¤–è¦æ±‚ï¼‰';

    const tc2 = p.title_config || {};
    const titleStyleDesc = tc2.style_desc || ph('æœªé…ç½®ï¼šæ ‡é¢˜é£æ ¼æè¿°');
    const _hrMap3 = { hot_dominant:'çƒ­ç‚¹ä¸»å¯¼ï¼ˆ70%çƒ­ç‚¹+30%è´¦å·è§†è§’ï¼‰', balanced:'å‡è¡¡èåˆï¼ˆ50%+50%ï¼‰', self_dominant:'è´¦å·ä¸»å¯¼ï¼ˆ30%çƒ­ç‚¹+70%è´¦å·è§†è§’ï¼‰', self_only:'çº¯è´¦å·è§†è§’' };
    const hotRatio = _hrMap3[tc2.hotspot_ratio||'balanced'] || 'å‡è¡¡èåˆ';
    const titleExtra = tc2.extra || 'ï¼ˆæ— ï¼‰';

    const c = p.content || {};
    const secCount = (c.section_count!=null && c.section_count!=='') ? c.section_count : 'ï¼ˆæœªè®¾ç½®ï¼‰';
    const wcMin = (c.word_count_min!=null && c.word_count_min!=='') ? c.word_count_min : 'ï¼ˆæœªè®¾ç½®ï¼‰';
    const wcMax = (c.word_count_max!=null && c.word_count_max!=='') ? c.word_count_max : 'ï¼ˆæœªè®¾ç½®ï¼‰';

    const mode = document.getElementById('at_mode')?.value || 'manual';
    const hotCount = document.getElementById('at_hot_title_count')?.value || 3;
    const selfCount = document.getElementById('at_self_title_count')?.value || 3;
    const autoCount = document.getElementById('at_auto_count')?.value || 3;
    const sources = _getChipValues('at_sources');
    const filterKw = document.getElementById('at_filter')?.value || '';
    const excludeKw = document.getElementById('at_exclude')?.value || '';

    const _withLineNumbers = (txt) => {
      const lines = String(txt||'').split('\n');
      return lines.map((l,i)=>`${String(i+1).padStart(4,' ')} | ${l}`).join('\n');
    };
    const _pre = (title, color, content) => `
      <div style="margin-bottom:16px;">
        <div style="color:${color}; font-weight:600; font-size:13px; margin-bottom:6px;">${title}</div>
        <pre style="background:#0f172a; padding:14px; border-radius:8px; font-size:12px; line-height:1.7; white-space:pre; overflow:auto; color:#cbd5e1; border:1px solid #334155; max-height:520px;">${_withLineNumbers(content)}</pre>
      </div>`;

    // Step 1: Topic selection prompt
    const topicPrompt = `## ç¬¬ä¸€æ­¥ï¼šè¯é¢˜ç­›é€‰ä¸æ ‡é¢˜ç”Ÿæˆ

æ•°æ®æ¥æºï¼š
- æ¯æ—¥çƒ­ç‚¹æ•°æ®åº“ï¼ˆtrend é¡¹ç›®ï¼‰ï¼š${sources.length ? sources.join(', ') : 'å…¨éƒ¨å¹³å°'}
- çƒ­ç‚¹æ€»é‡ï¼š${ph('è¿è¡Œæ—¶ï¼šä»Šæ—¥çƒ­ç‚¹æ¡æ•°')}
- å…³é”®è¯è¿‡æ»¤ï¼š${filterKw || 'ï¼ˆä¸é™ï¼‰'}
- æ’é™¤å…³é”®è¯ï¼š${excludeKw || 'ï¼ˆä¸é™ï¼‰'}

è´¦å·åŒ¹é…å‚æ•°ï¼š
- é¢†åŸŸï¼š${domain}
- äººè®¾ï¼š${persona}
- å—ä¼—ï¼š${audience}
- è°ƒæ€§å…³é”®è¯ï¼š${keywords}

åŒ¹é…é€»è¾‘ï¼š
1. ä»çƒ­ç‚¹æ•°æ®åº“åŠ è½½ä»Šæ—¥æ‰€æœ‰çƒ­ç‚¹
2. æŒ‰å…³é”®è¯è¿‡æ»¤ + æ’é™¤
3. å»é‡
4. ä¸ºè´¦å·ã€${acc.name || acc.id}ã€‘æ‰“åˆ†æ’åºï¼š
   - çƒ­ç‚¹ rank è¶Šé«˜ï¼ŒåŸºç¡€åˆ†è¶Šé«˜ï¼ˆtop1=14.5, top10=10ï¼‰
   - æ ‡é¢˜å‘½ä¸­è´¦å·é¢†åŸŸ/å…³é”®è¯ â†’ +10åˆ†/è¯
   - ä¸»æµå¹³å°ï¼ˆå¾®åš/ç™¾åº¦/å¤´æ¡/çŸ¥ä¹/æ¾æ¹ƒï¼‰â†’ +3åˆ†
5. å– Top ${hotCount} ä¸ªçƒ­ç‚¹æ ‡é¢˜ + ${selfCount} ä¸ªè‡ªä¸»é€‰é¢˜

${mode === 'manual' ? `æ¨¡å¼ï¼šäººå·¥ç¡®è®¤
â†’ ç”Ÿæˆ ğŸ”¥${hotCount} çƒ­ç‚¹ + âœ¨${selfCount} è‡ªä¸»é€‰é¢˜
â†’ å‘åˆ°é£ä¹¦ç¾¤ç­‰å¾…å›å¤é€‰æ‹©ï¼ˆå¦‚ A1,A4ï¼‰
â†’ é€‰å®šåè¿›å…¥å†…å®¹ç”Ÿæˆ` : `æ¨¡å¼ï¼šè‡ªåŠ¨
â†’ è‡ªåŠ¨é€‰æ‹© Top ${autoCount} ä¸ªè¯é¢˜
â†’ ç›´æ¥è¿›å…¥å†…å®¹ç”Ÿæˆ
â†’ ç”Ÿæˆå®Œæˆåå‘é£ä¹¦é“¾æ¥å¾…ç¡®è®¤æ¨é€`}`;

    // Step 2: Article generation prompt (same as Jobs flow)
    const articlePrompt = `## ç¬¬äºŒæ­¥ï¼šæ–‡ç« å†…å®¹ç”Ÿæˆï¼ˆä¸ Jobs é¡µé¢æµç¨‹ä¸€è‡´ï¼‰

ä½ æ˜¯ä¸€ä½${platform}å†…å®¹åˆ›ä½œè€…ã€‚

## è´¦å·å®šä½
- é¢†åŸŸï¼š${domain}
- äººè®¾ï¼š${persona}
- å—ä¼—ï¼š${audience}
- è¯­æ°”ï¼š${tone}
- è°ƒæ€§å…³é”®è¯ï¼š${keywords}
- é£æ ¼å‚è€ƒï¼š${reference}
- æ®µè½å»ºè®®ï¼š${secCount}
- å­—æ•°å»ºè®®ï¼š${wcMin} ~ ${wcMax}

## é¢å¤–è¦æ±‚
${extraInst}

## ä»»åŠ¡
è¯·æ ¹æ®ä»¥ä¸‹çƒ­ç‚¹ä¸»é¢˜ï¼Œåˆ›ä½œä¸€ç¯‡é«˜è´¨é‡${platform}æ–‡ç« ã€‚

ä¸»é¢˜/å…³é”®è¯ï¼š${ph('è‡ªåŠ¨é€‰é¢˜åŒ¹é…åˆ°çš„çƒ­ç‚¹æ ‡é¢˜')}
çƒ­ç‚¹æ¥æºï¼š${ph('å¹³å°åç§°ï¼Œå¦‚ ç™¾åº¦çƒ­æœ/å¾®åš')}
åŸå§‹é“¾æ¥ï¼š${ph('çƒ­ç‚¹åŸå§‹URLï¼ˆå¦‚æœ‰ï¼‰')}
æœç´¢è¡¥å……èµ„æ–™ï¼š${ph('æœç´¢å¼•æ“è¿”å›çš„èƒŒæ™¯ä¿¡æ¯ï¼ˆå¾…æ¥å…¥MCPï¼‰')}

è¦æ±‚ï¼š
1. æ ‡é¢˜è¦æœ‰å¸å¼•åŠ›å’Œç‚¹å‡»æ¬²
2. å†…å®¹æœ‰æ·±åº¦ã€æœ‰è§‚ç‚¹ã€æœ‰ä»·å€¼
3. ç»“æ„æ¸…æ™°ï¼Œæ®µè½åˆ†æ˜
4. ç¬¦åˆ${platform}å¹³å°çš„å†…å®¹è§„èŒƒå’Œç”¨æˆ·é˜…è¯»ä¹ æƒ¯

ç›´æ¥è¾“å‡ºæ ‡é¢˜å’Œæ­£æ–‡ã€‚`;

    // Step 3: Image prompts
    const coverPromptText = `## ç¬¬ä¸‰æ­¥Aï¼šå°é¢å›¾ç”Ÿæˆ

æ–‡ç« æ ‡é¢˜ï¼š${ph('ç¬¬äºŒæ­¥ç”Ÿæˆçš„æ–‡ç« æ ‡é¢˜')}
æ–‡ç« æ‘˜è¦ï¼š${ph('æ–‡ç« æ ¸å¿ƒè§‚ç‚¹æ¦‚è¦')}

åŸºç¡€è¦æ±‚ï¼ˆå·²å†…ç½®ï¼‰ï¼š
- åŸºäºæ–‡ç« è¯­ä¹‰ï¼Œè§†è§‰å¸å¼•åŠ›å¼º
- é€‚åˆ${platform}ä¿¡æ¯æµå±•ç¤º
- ${acc.platform === 'xhs' ? '3:4ç«–ç‰ˆæ¯”ä¾‹' : '16:9æ¨ªç‰ˆæ¯”ä¾‹'}

é¢å¤–é£æ ¼è¦æ±‚ï¼š${coverStyle}`;

    const inlinePromptText = `## ç¬¬ä¸‰æ­¥Bï¼šæ–‡ä¸­æ’å›¾ç”Ÿæˆï¼ˆå…± ${img.inline_count ?? 2} å¼ ï¼‰

æ‰€åœ¨æ®µè½æ ‡é¢˜ï¼š${ph('è¯¥æ®µè½çš„å°æ ‡é¢˜')}
æ®µè½æ ¸å¿ƒå†…å®¹ï¼š${ph('è¯¥æ®µè½çš„è¯­ä¹‰æ‘˜è¦ï¼Œç”±AIæ ¹æ®ä¸Šä¸‹æ–‡æç‚¼')}
æ–‡ç« æ•´ä½“ä¸»é¢˜ï¼š${ph('æ–‡ç« æ ‡é¢˜')}

åŸºç¡€è¦æ±‚ï¼ˆå·²å†…ç½®ï¼‰ï¼š
- ä¸æ®µè½å†…å®¹è¯­ä¹‰å¼ºç›¸å…³
- è§†è§‰å¸å¼•åŠ›å¼ºï¼Œæ„å›¾ç¾è§‚

é¢å¤–é£æ ¼è¦æ±‚ï¼š${inlineStyle}`;

    const atTitlePrompt = `ä¸ºä»¥ä¸‹çƒ­ç‚¹ä¸»é¢˜ç”Ÿæˆæ–‡ç« æ ‡é¢˜ã€‚

çƒ­ç‚¹ä¸»é¢˜ï¼š${ph('è‡ªåŠ¨é€‰é¢˜åŒ¹é…åˆ°çš„çƒ­ç‚¹æ ‡é¢˜')}
çƒ­ç‚¹æ¥æºï¼š${ph('å¹³å°åç§°')}

## è´¦å·å®šä½
- é¢†åŸŸï¼š${domain}
- äººè®¾ï¼š${persona}
- å—ä¼—ï¼š${audience}

## æ ‡é¢˜é£æ ¼è¦æ±‚
${titleStyleDesc}

## çƒ­ç‚¹èåˆç­–ç•¥
${hotRatio}

## æ ‡é¢˜é•¿åº¦ï¼ˆå­—æ•°å»ºè®®ï¼‰
- æœ€çŸ­ï¼š${titleLenMin}
- æœ€é•¿ï¼š${titleLenMax}

## é¢å¤–çº¦æŸ
${titleExtra}

è¯·ç”Ÿæˆ 3 ä¸ªå€™é€‰æ ‡é¢˜ï¼Œæ¯ä¸ªæ ‡é¢˜æ¢è¡Œè¾“å‡ºã€‚`;

    box.innerHTML =
        _pre('ğŸ¯ è¯é¢˜ç­›é€‰ä¸åŒ¹é…', '#a78bfa', topicPrompt) +
        _pre('ğŸ·ï¸ æ ‡é¢˜ç”Ÿæˆ Prompt', '#f472b6', atTitlePrompt) +
        _pre('ğŸ“ æ–‡ç« å†…å®¹ç”Ÿæˆ Prompt', '#60a5fa', articlePrompt) +
        _pre('ğŸ–¼ï¸ å°é¢å›¾ Prompt', '#f59e0b', coverPromptText) +
        _pre('ğŸ¨ æ–‡ä¸­æ’å›¾ Promptï¼ˆæ¯å¼ ï¼‰', '#4ade80', inlinePromptText);
}

// Populate autotopic debug account selector when loading autotopic tab
function refreshAutotopicDebugAccounts() {
    const sel = document.getElementById('at_debug_account');
    if (!sel) return;
    const opts = accountsCache.map(a => `<option value="${a.id}">${a.name} (${({wechat_mp:'å…¬ä¼—å·',xhs:'å°çº¢ä¹¦'})[a.platform]||a.platform})</option>`).join('');
    sel.innerHTML = '<option value="">(é€‰æ‹©è´¦å·)</option>' + opts;
}

// ==================== Topic Banks ====================
async function loadAccountsForTopicBanks() {
    // Ensure accountsCache exists
    if (!accountsCache || !accountsCache.length) {
        await loadAccounts();
    }
    const sel = document.getElementById('tb_account');
    if (!sel) return;
    sel.innerHTML = accountsCache.map(a => `<option value="${a.id}">${a.name} (${({wechat_mp:'å…¬ä¼—å·',xhs:'å°çº¢ä¹¦'})[a.platform]||a.platform})</option>`).join('');
    // auto load first
    await loadTopicBank();
}

async function loadTopicBank() {
    const accountId = document.getElementById('tb_account')?.value || '';
    if (!accountId) return;
    const box = document.getElementById('tb_json');
    if (box) box.value = 'åŠ è½½ä¸­...';
    try {
        const res = await fetch(API + `/topic_banks?account_id=${encodeURIComponent(accountId)}`);
        if (!res.ok) {
            const txt = await res.text();
            showToast(`åŠ è½½å¤±è´¥ï¼šHTTP ${res.status}`);
            if (box) box.value = txt || '';
            return;
        }
        const data = await res.json();
        if (!data.success) {
            showToast('åŠ è½½å¤±è´¥ï¼š' + (data.error || 'unknown'));
            if (box) box.value = '';
            return;
        }
        if (box) box.value = JSON.stringify(data.data || {}, null, 2);
    } catch(e) {
        showToast('åŠ è½½å¤±è´¥ï¼š' + (e.message || e));
        if (box) box.value = '';
    }
}

async function saveTopicBank() {
    const accountId = document.getElementById('tb_account')?.value || '';
    if (!accountId) { showToast('è¯·é€‰æ‹©è´¦å·'); return; }
    const box = document.getElementById('tb_json');
    if (!box) return;
    let obj = null;
    try {
        obj = JSON.parse(box.value);
    } catch(e) {
        showToast('JSON æ ¼å¼é”™è¯¯ï¼š' + e.message);
        return;
    }
    try {
        const res = await fetch(API + '/topic_banks', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({account_id: accountId, data: obj})
        });
        if (!res.ok) {
            const txt = await res.text();
            showToast(`ä¿å­˜å¤±è´¥ï¼šHTTP ${res.status}`);
            if (box) box.value = (box.value || '') + (txt ? `\n\n/* server */\n${txt}` : '');
            return;
        }
        const data = await res.json();
        if (!data.success) {
            showToast('ä¿å­˜å¤±è´¥ï¼š' + (data.error || 'unknown'));
            return;
        }
        showToast('âœ… å·²ä¿å­˜é€‰é¢˜åº“');
        await loadTopicBank();
    } catch(e) {
        showToast('ä¿å­˜å¤±è´¥ï¼š' + (e.message || e));
    }
}

// ==================== Stats ====================
async function loadAccountsForStats() {
    const res = await fetch(API + '/accounts');
    const data = await res.json();
    const sel = document.getElementById('stats_account');
    if (!sel) return;
    const accs = (data.accounts || []).filter(a => a.platform === 'wechat_mp');
    sel.innerHTML = '<option value="">ï¼ˆä½¿ç”¨å…¨å±€é…ç½®ï¼‰</option>' + accs.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
}

async function loadStats() {
    const accountId = document.getElementById('stats_account')?.value || '';
    const summary = document.getElementById('stats-summary');
    const list = document.getElementById('stats-list');
    summary.innerHTML = '<div style="color:#94a3b8;">åŠ è½½ä¸­...</div>';
    list.innerHTML = '';

    try {
        const res = await fetch(API + `/stats/wechat?account_id=${encodeURIComponent(accountId)}`);
        const data = await res.json();
        if (!data.success) {
            summary.innerHTML = `<div style="color:#f87171; padding:12px;">${data.error}</div>`;
            return;
        }
        summary.innerHTML = `
            <div class="card stat-card" style="flex:1;"><div class="stat-num">${data.total_count}</div><div class="stat-label">å·²å‘å¸ƒæ–‡ç« æ€»æ•°</div></div>
            <div class="card stat-card" style="flex:1;"><div class="stat-num">${data.articles.length}</div><div class="stat-label">æœ€è¿‘å±•ç¤º</div></div>
        `;
        list.innerHTML = data.articles.map(a => {
            const date = a.update_time ? new Date(a.update_time * 1000).toLocaleString('zh-CN') : '';
            return `<div class="draft-item">
                <div style="flex:1;">
                    <div style="font-weight:600;">${a.title}</div>
                    ${a.digest ? `<div style="color:#64748b; font-size:12px; margin-top:4px;">${a.digest}</div>` : ''}
                </div>
                <span style="color:#64748b; font-size:12px; white-space:nowrap; margin:0 12px;">${date}</span>
                ${a.url ? `<a href="${a.url}" target="_blank" class="btn btn-secondary btn-sm">æŸ¥çœ‹</a>` : ''}
            </div>`;
        }).join('') || '<div style="color:#94a3b8; padding:12px;">æš‚æ— å·²å‘å¸ƒæ–‡ç« </div>';
    } catch(e) {
        summary.innerHTML = `<div style="color:#f87171;">${e.message}</div>`;
    }
}

// ==================== GZH Pipeline (4-stage) ====================
async function pipelineLoadSettings() {
  try {
    const res = await fetch(API + '/gzh/settings');
    const data = await res.json();
    const gzh = data.gzh || {};
    const dedup = gzh.dedup || {};
    const quality = gzh.quality || {};
    const auto = quality.auto_rewrite || {};

    const th = document.getElementById('pipe_dedup_th');
    const ar = document.getElementById('pipe_autorewrite');
    const arth = document.getElementById('pipe_rewrite_th');
    if (th) th.value = (dedup.similarity_threshold ?? 0.82);
    if (ar) ar.value = (auto.enabled ? 'true' : 'false');
    if (arth) arth.value = (auto.score_threshold ?? 0.60);

    // SOP
    const sopRes = await fetch(API + '/gzh/sop');
    const sop = await sopRes.json();
    const box = document.getElementById('pipe_sop');
    if (box) box.textContent = (sop && sop.success) ? sop.markdown : ('åŠ è½½ SOP å¤±è´¥ï¼š' + (sop.error || 'unknown'));
  } catch(e) {
    showToast('åŠ è½½ç®¡çº¿é…ç½®å¤±è´¥ï¼š' + (e.message || e));
  }
}

async function pipelineSaveSettings() {
  const th = parseFloat(document.getElementById('pipe_dedup_th')?.value || '0.82');
  const autoEnabled = (document.getElementById('pipe_autorewrite')?.value || 'false') === 'true';
  const rewriteTh = parseFloat(document.getElementById('pipe_rewrite_th')?.value || '0.60');

  const payload = {
    gzh: {
      dedup: { similarity_threshold: th },
      quality: { auto_rewrite: { enabled: autoEnabled, score_threshold: rewriteTh } }
    }
  };
  try {
    const res = await fetch(API + '/gzh/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    const data = await res.json();
    if (!data.success) { showToast('ä¿å­˜å¤±è´¥ï¼š' + (data.error||'unknown')); return; }
    showToast('âœ… å·²ä¿å­˜ç®¡çº¿é…ç½®');
  } catch(e) {
    showToast('ä¿å­˜å¤±è´¥ï¼š' + (e.message || e));
  }
}

async function pipelineLoad(kind) {
  const idMap = {inspirations:'pipe_inspirations', topics:'pipe_topics', drafts:'pipe_drafts', published:'pipe_published'};
  const box = document.getElementById(idMap[kind]);
  if (!box) return;
  box.innerHTML = '<div style="color:#94a3b8; padding:10px;">åŠ è½½ä¸­...</div>';
  try {
    const res = await fetch(API + `/gzh/library/${kind}?limit=200`);
    const data = await res.json();
    if (!data.success) { box.innerHTML = `<div style="color:#f87171; padding:10px;">${data.error||'åŠ è½½å¤±è´¥'}</div>`; return; }
    const items = (data.items || []).slice().reverse();
    if (!items.length) { box.innerHTML = '<div style="color:#94a3b8; padding:10px;">æš‚æ— æ•°æ®</div>'; return; }

    box.innerHTML = items.map(it => {
      const title = it.title || it.topic_title || it.text || '(no title)';
      const sub = it.created_at || it.date || '';
      const extra = it.dedup && it.dedup.hit ? `<span style="color:#f59e0b; font-size:12px;">âš  ç›¸ä¼¼åº¦ ${Math.round((it.dedup.max_similarity||0)*100)}%</span>` : '';
      return `<div class="draft-item">
        <div style="flex:1;">
          <div style="font-weight:600;">${escapeHtml(title)}</div>
          <div style="color:#64748b; font-size:12px; margin-top:4px;">${escapeHtml(sub)} ${extra}</div>
        </div>
      </div>`;
    }).join('');
  } catch(e) {
    box.innerHTML = `<div style="color:#f87171; padding:10px;">${e.message||e}</div>`;
  }
}

function pipelineRefreshAll(){
  pipelineLoad('inspirations');
  pipelineLoad('topics');
  pipelineLoad('drafts');
  pipelineLoad('published');
}

async function pipelineAddInspiration(){
  const text = (document.getElementById('pipe_insp_text')?.value || '').trim();
  if (!text) { showToast('è¯·è¾“å…¥çµæ„Ÿå†…å®¹'); return; }
  try {
    const res = await fetch(API + '/gzh/inspirations', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text})});
    const data = await res.json();
    if (!data.success) { showToast('å…¥åº“å¤±è´¥ï¼š' + (data.error||'unknown')); return; }
    document.getElementById('pipe_insp_text').value = '';
    showToast('âœ… å·²å…¥åº“');
    pipelineLoad('inspirations');
  } catch(e) {
    showToast('å…¥åº“å¤±è´¥ï¼š' + (e.message||e));
  }
}

async function pipelineArchivePublished(){
  const account_id = (document.getElementById('pipe_pub_account')?.value || '').trim();
  const title = (document.getElementById('pipe_pub_title')?.value || '').trim();
  const url = (document.getElementById('pipe_pub_url')?.value || '').trim();
  if (!account_id || !title) { showToast('account_id å’Œ title å¿…å¡«'); return; }
  try {
    const res = await fetch(API + '/gzh/published', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({account_id, title, wechat:{url}})});
    const data = await res.json();
    if (!data.success) { showToast('å½’æ¡£å¤±è´¥ï¼š' + (data.error||'unknown')); return; }
    showToast('âœ… å·²å½’æ¡£');
    pipelineLoad('published');
  } catch(e) {
    showToast('å½’æ¡£å¤±è´¥ï¼š' + (e.message||e));
  }
}

async function pipelineIncubateTopics(){
  // Web-first: generate topic candidates and append into data/gzh/topics.jsonl
  try {
    const res = await fetch(API + '/gzh/topic_incubate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})});
    const data = await res.json();
    if (!data.success) { showToast('ç”Ÿæˆå¤±è´¥ï¼š' + (data.error||'unknown')); return; }
    const cnt = (data.result && data.result.count) ? data.result.count : 0;
    showToast('âœ… å·²å†ç”Ÿäº§é€‰é¢˜å¹¶è½åº“ï¼š' + cnt + ' æ¡');
    pipelineLoad('topics');
  } catch(e) {
    showToast('è§¦å‘å¤±è´¥ï¼š' + (e.message||e));
  }
}

function escapeHtml(s){
  return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

// ==================== Init ====================
(async function init() {
    const res = await fetch(API + '/themes');
    window._allThemes = await res.json();
    loadThemes();
    loadAccounts();
    loadDrafts();
    loadWriters();
})();
</script>
</body>
</html>
